

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="测开求职者">
  <meta name="keywords" content="">
  
    <meta name="description" content="基于Pytest和MCP Server的接口自动化测试框架开发">
<meta property="og:type" content="article">
<meta property="og:title" content="自动化测试框架开发">
<meta property="og:url" content="https://lilpear2002.github.io/2026/01/14/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6%E5%BC%80%E5%8F%91/index.html">
<meta property="og:site_name" content="测开学习之路">
<meta property="og:description" content="基于Pytest和MCP Server的接口自动化测试框架开发">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://lilpear2002.github.io/img/test.jpg">
<meta property="article:published_time" content="2026-01-14T02:15:53.000Z">
<meta property="article:modified_time" content="2026-01-18T07:54:09.132Z">
<meta property="article:author" content="测开求职者">
<meta property="article:tag" content="MCP Server">
<meta property="article:tag" content="UI测试">
<meta property="article:tag" content="接口测试">
<meta property="article:tag" content="自动化测试">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://lilpear2002.github.io/img/test.jpg">
  
  
  
  <title>自动化测试框架开发 - 测开学习之路</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"lilpear2002.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 8.1.1"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/Java/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Java基础</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/Python/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Python基础</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/Testing/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>测试基础</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/%E7%AE%97%E6%B3%95/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>leetcode</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>数据库</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/Java%E9%A1%B9%E7%9B%AE/" target="_self">
                <i class="iconfont icon-bookmark-fill"></i>
                <span>Java项目</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/%E6%B5%8B%E5%BC%80%E9%A1%B9%E7%9B%AE/" target="_self">
                <i class="iconfont icon-bookmark-fill"></i>
                <span>测开项目</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/%E7%A7%91%E7%A0%94%E7%BB%8F%E5%8E%86/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>科研经历</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/LLM/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>大模型</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="自动化测试框架开发"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2026-01-14 10:15" pubdate>
          2026年1月14日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          10k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          87 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">自动化测试框架开发</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="理解架构与项目目录"><a href="#理解架构与项目目录" class="headerlink" title="理解架构与项目目录"></a>理解架构与项目目录</h1><img src="/2026/01/14/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6%E5%BC%80%E5%8F%91/image1.png" srcset="/img/loading.gif" lazyload class="" title="项目目录">

<ul>
<li><strong><code>api_test/</code></strong>: 项目根目录<ul>
<li><strong><code>common/</code></strong>: <strong>核心层</strong>。存放通用的封装，比如 <code>Request</code> 请求类的二次封装、日志（Logger）封装、断言封装。这是框架的“引擎”。</li>
<li><strong><code>config/</code></strong>: <strong>配置层</strong>。存放配置文件（如 <code>config.yaml</code>），管理环境地址（测试环境&#x2F;生产环境 URL）、数据库账号等。</li>
<li><strong><code>data/</code></strong>: <strong>数据层</strong>。存放测试数据（YAML&#x2F;Excel），实现<strong>数据驱动测试 (DDT)</strong>，实现代码与数据分离。</li>
<li><strong><code>logs/</code></strong>: <strong>日志层</strong>。存放运行时生成的日志文件。</li>
<li><strong><code>reports/</code></strong>: <strong>报告层</strong>。存放 Allure 生成的测试报告数据和 HTML 页面。</li>
<li><strong><code>test_cases/</code></strong>: <strong>业务层</strong>。存放具体的测试用例脚本，按模块划分（如 <code>test_login.py</code>, <code>test_order.py</code>）。</li>
<li><strong><code>utils/</code></strong>: <strong>工具层</strong>。存放工具函数，比如读取 YAML 的工具、生成随机数据的工具、连接数据库的工具。</li>
<li><strong><code>pytest.ini</code></strong>: Pytest 的核心配置文件。</li>
<li><strong><code>requirements.txt</code></strong>: 依赖包管理。</li>
<li><strong><code>run.py</code></strong>: 项目的主入口文件。</li>
</ul>
</li>
</ul>
<p><code>pytest.ini</code> 是指挥塔，决定了测试怎么跑。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[pytest]</span><br><br><span class="hljs-comment">; 命令行参数，默认每次执行都显示详细过程(-vs) 并 指定allure数据生成路径</span><br><span class="hljs-comment">;每次运行测试时自动添加的参数：</span><br><span class="hljs-comment">;-v：详细输出（显示每个测试用例的名称和结果）</span><br><span class="hljs-comment">;-s：显示测试中的 print 输出（不捕获标准输出）</span><br><span class="hljs-comment">;--alluredir=./reports/temp：将 Allure 报告数据保存到指定目录</span><br><span class="hljs-comment">;--clean-alluredir：运行前清理之前的 Allure 数据</span><br><span class="hljs-attr">addopts</span> = -vs --alluredir=./reports/temp --clean-alluredir<br><br><span class="hljs-comment">; 指定测试用例的搜索目录 在 test_cases 目录下查找测试文件</span><br><span class="hljs-attr">testpaths</span> = test_cases<br><br><span class="hljs-comment">; 指定测试文件的命名规则 只识别以 test_ 开头的 Python 文件</span><br><span class="hljs-attr">python_files</span> = test_*.py<br><br><span class="hljs-comment">; 指定测试类的命名规则 测试类必须以 Test 开头</span><br><span class="hljs-attr">python_classes</span> = Test*<br><br><span class="hljs-comment">; 指定测试函数的命名规则 测试函数必须以 test_ 开头</span><br><span class="hljs-attr">python_functions</span> = test_*<br><br><span class="hljs-comment">; 注册自定义标记（Marker），防止运行时报警告</span><br><span class="hljs-attr">markers</span> =<br>    smoke: 冒烟测试<br>    user: 用户模块<br>    product: 商品模块<br>    order: 订单模块<br></code></pre></td></tr></table></figure>

<blockquote>
<p>为什么要配置这个？为了标准化执行。比如 <code>--clean-alluredir</code> 可以保证每次生成报告前自动清理旧数据，防止报告混乱。</p>
</blockquote>
<hr>
<p>不应该把 URL 硬编码在代码里（比如写死 <code>http://localhost:5000</code>），因为将来还要切换测试环境、线上环境。用 YAML 文件来管理。在 <code>config</code> 目录下新建文件 <code>config.yaml</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># config/config.yaml</span><br><br><span class="hljs-comment"># 当前环境配置</span><br><span class="hljs-attr">env:</span><br>  <span class="hljs-attr">base_url:</span> <span class="hljs-string">&quot;http://localhost:5000/api&quot;</span>  <span class="hljs-comment"># 这里根据API文档的基础信息填写</span><br><br>  <span class="hljs-comment"># 如果有数据库配置也可以放这里</span><br>  <span class="hljs-attr">db_path:</span> <span class="hljs-string">&quot;D:\\Workspace\\flask-project\\flask_app\\instance\\app.db&quot;</span><br></code></pre></td></tr></table></figure>

<hr>
<p>现在有了配置文件，需要写一段代码来读取它。</p>
<ol>
<li>在 <code>utils</code> 目录下新建 <code>yaml_util.py</code>。</li>
<li>写入以下代码：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> yaml<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">YamlUtil</span>:<br>    <span class="hljs-comment"># 获取项目根目录，兼容不同操作系统</span><br>    <span class="hljs-comment"># __file__：当前文件路径</span><br>	<span class="hljs-comment"># os.path.abspath()：转为绝对路径</span><br>	<span class="hljs-comment"># os.path.dirname()：两次获取父目录（回到项目根目录）</span><br>    ROOT_PATH = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))<br><br>    <span class="hljs-comment"># @staticmethod：静态方法，无需创建类实例即可调用</span><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_config</span>():<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        读取 config.yaml 配置文件</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 使用 os.path.join()：自动处理不同操作系统的路径分隔符</span><br>        config_path = os.path.join(YamlUtil.ROOT_PATH, <span class="hljs-string">&quot;config&quot;</span>, <span class="hljs-string">&quot;config.yaml&quot;</span>)<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(config_path, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>                <span class="hljs-comment"># 使用 yaml.safe_load() 安全加载 YAML（防止执行恶意代码）</span><br>                <span class="hljs-comment"># 返回解析后的 Python 数据结构（通常是字典）</span><br>                <span class="hljs-keyword">return</span> yaml.safe_load(f)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;读取配置文件失败: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_test_data</span>(<span class="hljs-params">yaml_name</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        读取 data 目录下的测试数据</span><br><span class="hljs-string">        :param yaml_name: 文件名，如 login_data.yaml</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        data_path = os.path.join(YamlUtil.ROOT_PATH, <span class="hljs-string">&quot;data&quot;</span>, yaml_name)<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(data_path, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>                <span class="hljs-keyword">return</span> yaml.safe_load(f)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;读取测试数据失败: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><span class="hljs-comment"># 简单的测试代码，运行该文件看看能不能打印出配置</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-built_in">print</span>(YamlUtil.read_config())<br></code></pre></td></tr></table></figure>

<hr>
<p>太好了，能够跟上节奏说明你的执行力很强。现在我们进入<strong>第二阶段：核心封装</strong>。</p>
<p>这一步在面试中是<strong>重中之重</strong>。面试官经常问：“<em>你的框架里是怎么处理 HTTP 请求的？怎么管理 Session？怎么做统一日志记录的？</em>”</p>
<p>我们将通过封装 <code>requests</code> 来回答这些问题。</p>
<hr>
<h1 id="封装日志与请求核心-Common-层"><a href="#封装日志与请求核心-Common-层" class="headerlink" title="封装日志与请求核心 (Common 层)"></a>封装日志与请求核心 (Common 层)</h1><p>需要在 <code>common</code> 目录下新建两个核心文件。</p>
<h2 id="1-日志封装"><a href="#1-日志封装" class="headerlink" title="1. 日志封装"></a>1. 日志封装</h2><p>如果不封装日志，报错了只能看到控制台一闪而过的信息。所以需要把测试过程中的请求、响应、报错都写入文件，方便排查问题。</p>
<p>在 <code>common</code> 目录下新建 <code>logger_util.py</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> logging<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> os<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggerUtil</span>:<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_log</span>(<span class="hljs-params">self, logger_name=<span class="hljs-string">&#x27;log&#x27;</span></span>):<br>        <span class="hljs-comment"># 1. 创建日志收集器</span><br>        <span class="hljs-comment"># 使用 logging.getLogger() 获取或创建日志收集器</span><br>        <span class="hljs-comment"># 通过 logger_name 参数可以创建不同的日志器实例</span><br>        <span class="hljs-variable language_">self</span>.logger = logging.getLogger(logger_name)<br>        <span class="hljs-comment"># 收集器级别：DEBUG及以上</span><br>        <span class="hljs-variable language_">self</span>.logger.setLevel(logging.DEBUG)<br><br>        <span class="hljs-comment"># 2. 防止日志重复打印（面试常考点：单例模式或判断handlers）</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.logger.handlers:<br>            <span class="hljs-comment"># 3. 定义日志文件的路径和文件名</span><br>            <span class="hljs-comment"># 获取项目根目录</span><br>            root_path = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))<br>            <span class="hljs-comment"># 拼接 logs 目录</span><br>            log_path = os.path.join(root_path, <span class="hljs-string">&quot;logs&quot;</span>)<br>            <span class="hljs-comment"># 如果目录不存在则创建</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(log_path):<br>                os.mkdir(log_path)<br>                <br>            <span class="hljs-comment"># 文件名按日期命名，如 2024-01-01_test.log</span><br>            current_time = time.strftime(<span class="hljs-string">&quot;%Y-%m-%d&quot;</span>)<br>            log_file_name = os.path.join(log_path, <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;current_time&#125;</span>_test.log&quot;</span>)<br><br>            <span class="hljs-comment"># 4. 创建文件处理器（FileHandler）- 写入文件</span><br>            file_handler = logging.FileHandler(log_file_name, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>            <span class="hljs-comment"># 文件级别：INFO及以上</span><br>            file_handler.setLevel(logging.INFO)<br><br>            <span class="hljs-comment"># 5. 创建控制台处理器（StreamHandler）- 输出到控制台 </span><br>            console_handler = logging.StreamHandler()<br>            <span class="hljs-comment"># 控制台级别：INFO及以上</span><br>            console_handler.setLevel(logging.INFO)<br><br>            <span class="hljs-comment"># 6. 定义日志格式</span><br>            <span class="hljs-comment"># 时间 - 文件名[行号] - 日志级别 - 消息</span><br>            formatter = logging.Formatter(<br>                <span class="hljs-string">&#x27;%(asctime)s - %(filename)s[line:%(lineno)d] - %(levelname)s: %(message)s&#x27;</span><br>            )<br>            file_handler.setFormatter(formatter)<br>            console_handler.setFormatter(formatter)<br><br>            <span class="hljs-comment"># 7. 添加处理器到收集器</span><br>            <span class="hljs-variable language_">self</span>.logger.addHandler(file_handler)<br>            <span class="hljs-variable language_">self</span>.logger.addHandler(console_handler)<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.logger<br><br><span class="hljs-comment"># 全局初始化一个 logger 供其他模块直接导入使用</span><br>logger = LoggerUtil().create_log()<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="2-Requests-二次封装"><a href="#2-Requests-二次封装" class="headerlink" title="2. Requests 二次封装"></a>2. Requests 二次封装</h2><p><strong>核心设计思路：</strong></p>
<ol>
<li><strong>统一入口</strong>：所有测试用例都调用这个类，而不是直接调 <code>requests.post</code>。</li>
<li><strong>Session 管理</strong>：使用 <code>requests.Session()</code>，它会自动管理 Cookie 和连接池，模拟浏览器的行为。</li>
<li><strong>全局日志</strong>：在发送前打印请求参数，在响应后打印返回结果。</li>
<li><strong>异常处理</strong>：统一捕获网络异常。</li>
</ol>
<p>在 <code>common</code> 目录下新建 <code>request_util.py</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> common.logger_util <span class="hljs-keyword">import</span> logger<br><span class="hljs-keyword">from</span> utils.yaml_util <span class="hljs-keyword">import</span> YamlUtil<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestUtil</span>:<br>    <span class="hljs-comment"># 类变量，保证全局只有一个 session 对象（保持会话连续性，比如登录后的 Cookie）</span><br>    <span class="hljs-comment"># 持久会话 指的是在多次HTTP请求之间保持连接状态和上下文信息的能力</span><br>    sess = requests.Session()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">send_request</span>(<span class="hljs-params">self, method, url, **kwargs</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        统一请求方法</span><br><span class="hljs-string">        :param method: 请求方式 (get, post, put, delete)</span><br><span class="hljs-string">        :param url: 接口路径 (不需要写 base_url，只需要写 /auth/login 这种)</span><br><span class="hljs-string">        :param kwargs: 其他参数 (json, params, data, headers...)</span><br><span class="hljs-string">        :return: 响应内容的文本或JSON</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <br>        <span class="hljs-comment"># 1. 处理 URL：从配置文件读取 Base URL 进行拼接</span><br>        <span class="hljs-comment"># 读取 config.yaml</span><br>        config = YamlUtil.read_config()<br>        base_url = config[<span class="hljs-string">&#x27;env&#x27;</span>][<span class="hljs-string">&#x27;base_url&#x27;</span>]<br>        full_url = base_url + url<br><br>        <span class="hljs-comment"># 2. 统一日志记录 - 请求前</span><br>        method = method.lower() <span class="hljs-comment"># 转小写</span><br>        logger.info(<span class="hljs-string">&quot;----------------------------------&quot;</span>)<br>        logger.info(<span class="hljs-string">f&quot;接口请求开始 &gt;&gt;&gt;&quot;</span>)<br>        logger.info(<span class="hljs-string">f&quot;请求地址: <span class="hljs-subst">&#123;full_url&#125;</span>&quot;</span>)<br>        logger.info(<span class="hljs-string">f&quot;请求方式: <span class="hljs-subst">&#123;method&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;json&quot;</span> <span class="hljs-keyword">in</span> kwargs:<br>            logger.info(<span class="hljs-string">f&quot;请求Body(json): <span class="hljs-subst">&#123;kwargs[<span class="hljs-string">&#x27;json&#x27;</span>]&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;params&quot;</span> <span class="hljs-keyword">in</span> kwargs:<br>            logger.info(<span class="hljs-string">f&quot;请求Query(params): <span class="hljs-subst">&#123;kwargs[<span class="hljs-string">&#x27;params&#x27;</span>]&#125;</span>&quot;</span>)<br><br>        <span class="hljs-comment"># 3. 发送请求</span><br>        res = <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-comment"># 这里的 **kwargs 是 Python 的解包操作，把参数透传给 requests</span><br>            <span class="hljs-comment"># 比如 send_request(..., json=data) -&gt; requests.request(..., json=data)</span><br>            res = RequestUtil.sess.request(method=method, url=full_url, **kwargs)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            logger.error(<span class="hljs-string">f&quot;请求发送异常: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">raise</span> e<br><br>        <span class="hljs-comment"># 4. 统一日志记录 - 响应后</span><br>        <span class="hljs-comment"># 打印状态码</span><br>        logger.info(<span class="hljs-string">f&quot;响应状态码: <span class="hljs-subst">&#123;res.status_code&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-comment"># 尝试解析 JSON，如果不是 JSON 可能会报错</span><br>            logger.info(<span class="hljs-string">f&quot;响应内容: <span class="hljs-subst">&#123;res.json()&#125;</span>&quot;</span>)<br>        <span class="hljs-keyword">except</span>:<br>            logger.info(<span class="hljs-string">f&quot;响应内容(Text): <span class="hljs-subst">&#123;res.text&#125;</span>&quot;</span>)<br>        <br>        logger.info(<span class="hljs-string">f&quot;接口请求结束 &lt;&lt;&lt;&quot;</span>)<br>        <br>        <span class="hljs-keyword">return</span> res<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="3-验证核心代码"><a href="#3-验证核心代码" class="headerlink" title="3. 验证核心代码"></a>3. 验证核心代码</h2><p>在根目录新建一个 <code>temp_run.py</code> (临时文件)，测试一下封装是否成功。</p>
<p>测试目标：</p>
<ul>
<li><strong>API</strong>: <code>GET /categories</code></li>
<li><strong>权限</strong>: 否</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> common.request_util <span class="hljs-keyword">import</span> RequestUtil<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_demo</span>():<br>    <span class="hljs-comment"># 实例化请求工具</span><br>    req = RequestUtil()<br>    <br>    <span class="hljs-comment"># 发送请求</span><br>    <span class="hljs-comment"># 注意：这里不用写 http://localhost:5000/api，因为封装里已经拼接了</span><br>    res = req.send_request(method=<span class="hljs-string">&quot;get&quot;</span>, url=<span class="hljs-string">&quot;/categories&quot;</span>)<br>    <br>    <span class="hljs-comment"># 简单的断言</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;测试脚本打印结果:&quot;</span>, res.json())<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    test_demo()<br></code></pre></td></tr></table></figure>

<ol>
<li><strong>运行并检查</strong>：<ul>
<li>运行 <code>temp_run.py</code>。</li>
<li><strong>预期结果 1</strong>：控制台打印出分类的 JSON 数据（电子产品、服装鞋帽等）。</li>
<li><strong>预期结果 2</strong>：项目目录下 <code>logs</code> 文件夹，应该生成了一个 <code>.log</code> 文件，打开它，里面详细记录了请求的 URL、方式和响应内容。</li>
</ul>
</li>
</ol>
<hr>
<h1 id="登录模块与-Token-治理（接口依赖）"><a href="#登录模块与-Token-治理（接口依赖）" class="headerlink" title="登录模块与 Token 治理（接口依赖）"></a>登录模块与 Token 治理（接口依赖）</h1><p>问：“<em>登录后的 Token 你是怎么处理的？后续接口如何使用这个 Token？</em>”</p>
<p><strong>解决方案：</strong></p>
<ol>
<li><strong>数据驱动 (DDT)</strong>：把用户名密码写在 <code>YAML</code> 里，而不是代码里。</li>
<li><strong>接口依赖处理</strong>：在登录成功后，使用 <code>jsonpath</code> 提取 Token。</li>
<li><strong>中间变量存储</strong>：将 Token 写入一个临时的 <code>extract.yaml</code> 文件，后续的购物车、订单接口读取这个文件来获取 Token。</li>
</ol>
<hr>
<h2 id="1-准备测试数据"><a href="#1-准备测试数据" class="headerlink" title="1. 准备测试数据"></a>1. 准备测试数据</h2><p><strong>操作：</strong></p>
<ol>
<li>在 <code>data</code> 目录下新建 <code>login_data.yaml</code>。</li>
<li>写入以下内容（包含一个正向用例，将来可以加反向用例）：</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">case_name:</span> <span class="hljs-string">&quot;正向登录_登录成功&quot;</span><br>  <span class="hljs-attr">request:</span><br>    <span class="hljs-attr">method:</span> <span class="hljs-string">&quot;post&quot;</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">&quot;/auth/login&quot;</span><br>    <span class="hljs-attr">json:</span><br>      <span class="hljs-attr">username:</span> <span class="hljs-string">&quot;testuser&quot;</span><br>      <span class="hljs-attr">password:</span> <span class="hljs-string">&quot;123456&quot;</span><br>  <span class="hljs-attr">validate:</span><br>    <span class="hljs-attr">status_code:</span> <span class="hljs-number">200</span> <span class="hljs-comment"># 期望的状态码</span><br>    <span class="hljs-attr">message:</span> <span class="hljs-string">&quot;登录成功&quot;</span> <span class="hljs-comment"># 期望的响应信息</span><br></code></pre></td></tr></table></figure>

<hr>
<h2 id="2-编写“变量提取器”工具"><a href="#2-编写“变量提取器”工具" class="headerlink" title="2. 编写“变量提取器”工具"></a>2. 编写“变量提取器”工具</h2><p>需要一个工具，专门用来把登录拿到的 Token <strong>存起来</strong>，和把存起来的 Token <strong>读出来</strong>。</p>
<p><strong>操作：</strong></p>
<ol>
<li>在 <code>utils</code> 目录下新建 <code>extract_util.py</code>。</li>
<li>写入以下代码：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> yaml<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ExtractUtil</span>:<br>    <span class="hljs-comment"># 获取项目根目录</span><br>    ROOT_PATH = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))<br>    <span class="hljs-comment"># 定义临时文件 extract.yaml 的路径</span><br>    EXTRACT_YAML_PATH = os.path.join(ROOT_PATH, <span class="hljs-string">&quot;extract.yaml&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">write_extract_yaml</span>(<span class="hljs-params">self, data</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        写入中间变量到 extract.yaml (追加模式 &#x27;a&#x27;)</span><br><span class="hljs-string">        :param data: 字典数据，例如 &#123;&quot;access_token&quot;: &quot;eyJ...&quot;&#125;</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-variable language_">self</span>.EXTRACT_YAML_PATH, mode=<span class="hljs-string">&#x27;a&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            <span class="hljs-comment"># 将Python对象转换为YAML格式并写入</span><br>            yaml.dump(data, stream=f, allow_unicode=<span class="hljs-literal">True</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_extract_yaml</span>(<span class="hljs-params">self, key</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        读取 extract.yaml 中的变量</span><br><span class="hljs-string">        :param key: 要读取的键名</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-variable language_">self</span>.EXTRACT_YAML_PATH, mode=<span class="hljs-string">&#x27;r&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>                value = yaml.safe_load(f)<br>                <span class="hljs-keyword">return</span> value.get(key)<br>        <span class="hljs-keyword">except</span> Exception:<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">clear_extract_yaml</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        清除 extract.yaml (每次测试开始前清理旧数据)</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-variable language_">self</span>.EXTRACT_YAML_PATH, mode=<span class="hljs-string">&#x27;w&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            f.truncate()<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="3-编写登录测试用例"><a href="#3-编写登录测试用例" class="headerlink" title="3. 编写登录测试用例"></a>3. 编写登录测试用例</h2><p>现在把它们串起来。用到 <code>pytest</code> 的参数化功能，自动读取 YAML 里的数据来跑测试。</p>
<p><strong>操作：</strong></p>
<ol>
<li>在 <code>test_cases</code> 目录下新建一个文件夹 <code>test_auth</code>（按模块管理）。</li>
<li>在 <code>test_auth</code> 下新建 <code>test_login.py</code>。</li>
<li>写入以下代码：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pytest<br><span class="hljs-keyword">import</span> allure<br><span class="hljs-keyword">from</span> common.request_util <span class="hljs-keyword">import</span> RequestUtil<br><span class="hljs-keyword">from</span> utils.yaml_util <span class="hljs-keyword">import</span> YamlUtil<br><span class="hljs-keyword">from</span> utils.extract_util <span class="hljs-keyword">import</span> ExtractUtil<br><br><br><span class="hljs-comment"># @allure.epic：项目/史诗级分类</span><br><span class="hljs-comment"># @allure.feature：功能模块分类</span><br><span class="hljs-meta">@allure.epic(<span class="hljs-params"><span class="hljs-string">&quot;Flask商城接口测试&quot;</span></span>)</span><br><span class="hljs-meta">@allure.feature(<span class="hljs-params"><span class="hljs-string">&quot;用户认证模块&quot;</span></span>)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">TestLogin</span>:<br><br>    <span class="hljs-comment"># 1. 读取测试数据</span><br>    data_list = YamlUtil.read_test_data(<span class="hljs-string">&quot;login_data.yaml&quot;</span>)<br><br>    <span class="hljs-comment"># @allure.story：用户故事/具体功能点</span><br><span class="hljs-meta">    @allure.story(<span class="hljs-params"><span class="hljs-string">&quot;用户登录接口&quot;</span></span>)</span><br>    <span class="hljs-comment"># 使用数据驱动测试，从 data_list 中读取多组测试数据</span><br><span class="hljs-meta">    @pytest.mark.parametrize(<span class="hljs-params"><span class="hljs-string">&quot;case_info&quot;</span>, data_list</span>)</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_login</span>(<span class="hljs-params">self, case_info</span>):<br>        <span class="hljs-comment"># --- 步骤 1: 准备数据 ---</span><br>        url = case_info[<span class="hljs-string">&#x27;request&#x27;</span>][<span class="hljs-string">&#x27;url&#x27;</span>]<br>        method = case_info[<span class="hljs-string">&#x27;request&#x27;</span>][<span class="hljs-string">&#x27;method&#x27;</span>]<br>        json_data = case_info[<span class="hljs-string">&#x27;request&#x27;</span>][<span class="hljs-string">&#x27;json&#x27;</span>]<br>        <br>        <span class="hljs-comment"># --- 步骤 2: 发送请求 ---</span><br>        req = RequestUtil()<br>        res = req.send_request(method=method, url=url, json=json_data)<br>        <span class="hljs-comment"># 将响应的 JSON 字符串解析为 Python 对象</span><br>        result = res.json()<br><br>        <span class="hljs-comment"># --- 步骤 3: 断言 (验证结果) ---</span><br>        <span class="hljs-comment"># HTTP 响应状态码 (不是响应体中的业务状态码)</span><br>        <span class="hljs-keyword">assert</span> res.status_code == case_info[<span class="hljs-string">&#x27;validate&#x27;</span>][<span class="hljs-string">&#x27;status_code&#x27;</span>]<br>        <span class="hljs-comment"># 验证响应体中的消息</span><br>        <span class="hljs-keyword">assert</span> case_info[<span class="hljs-string">&#x27;validate&#x27;</span>][<span class="hljs-string">&#x27;message&#x27;</span>] <span class="hljs-keyword">in</span> result[<span class="hljs-string">&#x27;message&#x27;</span>]<br><br>        <span class="hljs-comment"># --- 步骤 4: 关键！提取 Token (接口依赖) ---</span><br>        <span class="hljs-comment"># 只有登录成功才提取</span><br>        <span class="hljs-keyword">if</span> result[<span class="hljs-string">&#x27;code&#x27;</span>] == <span class="hljs-number">200</span>:<br>            <span class="hljs-comment"># 根据 API 文档，token 在 data -&gt; token 字段</span><br>            token = result[<span class="hljs-string">&#x27;data&#x27;</span>][<span class="hljs-string">&#x27;token&#x27;</span>]<br>            <br>            <span class="hljs-comment"># 写入 extract.yaml</span><br>            ExtractUtil().write_extract_yaml(&#123;<span class="hljs-string">&quot;access_token&quot;</span>: token&#125;)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Token 已提取并保存: <span class="hljs-subst">&#123;token[:<span class="hljs-number">20</span>]&#125;</span>...&quot;</span>) <br></code></pre></td></tr></table></figure>

<hr>
<h2 id="4-验证与运行"><a href="#4-验证与运行" class="headerlink" title="4. 验证与运行"></a>4. 验证与运行</h2><p>现在跑一下这个测试，看看能不能成功登录并把 Token 存下来。</p>
<p><strong>操作：</strong></p>
<ol>
<li><p>先手动在项目根目录新建一个空的 <code>extract.yaml</code> 文件（防止第一次运行报错，虽然后面会自动清理，但先建一个保险）。</p>
</li>
<li><p>运行 <code>test_cases/test_auth/test_login.py</code>。</p>
<ul>
<li><p>直接点击函数旁边的绿色箭头。</p>
</li>
<li><p>或在终端输入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pytest test_cases/test_auth/test_login.py -vs<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<p><strong>检查结果：</strong></p>
<ol>
<li><p><strong>控制台</strong>：应该显示 <code>PASSED</code>，并且打印出 “Token 已提取并保存…”。</p>
</li>
<li><p><strong>文件检查</strong>：打开根目录下的 <code>extract.yaml</code>，能看到类似这样的内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">access_token:</span> <span class="hljs-string">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...</span><br></code></pre></td></tr></table></figure></li>
</ol>
<hr>
<h1 id="Fixture配置"><a href="#Fixture配置" class="headerlink" title="Fixture配置"></a>Fixture配置</h1><p><strong>fixture 是什么？</strong></p>
<ul>
<li>fixture 是 pytest 的测试夹具</li>
<li>用于准备测试数据、初始化环境、清理资源</li>
<li>可以理解为测试用例的 “前置条件” 和 “后置处理”</li>
</ul>
<p>问：<em>“你的接口关联（数据依赖）是用 Fixture 实现的，还是用全局变量&#x2F;文件实现的？优缺点是什么？”</em></p>
<p>刚才的步骤中<strong>暂时</strong>没有用 <code>fixture</code>，主要基于以下两个考量：</p>
<h2 id="1-先“显式”后“隐式”"><a href="#1-先“显式”后“隐式”" class="headerlink" title="1. 先“显式”后“隐式”"></a>1. 先“显式”后“隐式”</h2><ul>
<li><strong>文件提取法 (<code>extract.yaml</code>)</strong> 是<strong>显式</strong>的。<ul>
<li><strong>可视化强</strong>：能亲眼看到生成的 <code>yaml</code> 文件里真的多了一行 <code>token</code>，这对于理解“接口依赖”的本质（上一个接口的返回值是下一个接口的参数）非常直观。</li>
<li><strong>调试方便</strong>：如果后续接口报错，直接打开文件就能确认：Token 到底有没有提取成功？是不是提取错了？</li>
</ul>
</li>
<li><strong>Fixture</strong> 是<strong>隐式</strong>的（黑盒）。<ul>
<li>它在后台静默运行，初学者容易晕：“数据到底传哪去了？”。</li>
</ul>
</li>
</ul>
<h2 id="2-Fixture-vs-中间文件"><a href="#2-Fixture-vs-中间文件" class="headerlink" title="2. Fixture vs 中间文件"></a>2. Fixture vs 中间文件</h2><p>在真实的工业级框架中，这两种方式通常是<strong>结合使用</strong>的。需要根据<strong>数据的生命周期</strong>来选择：</p>
<table>
<thead>
<tr>
<th><strong>维度</strong></th>
<th><strong>Fixture (conftest.py)</strong></th>
<th><strong>中间文件&#x2F;全局变量 (extract.yaml)</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>适用场景</strong></td>
<td><strong>前置准备&#x2F;全局配置</strong></td>
<td><strong>业务链路的数据传递</strong></td>
</tr>
<tr>
<td><strong>典型例子</strong></td>
<td><strong>全局登录</strong>、数据库连接、浏览器驱动启动。</td>
<td><strong>创建订单 -&gt; 支付订单</strong>（支付接口需要上一步创建的 OrderID）。</td>
</tr>
<tr>
<td><strong>生命周期</strong></td>
<td>通常伴随整个 Session 或 Class（<code>scope=&quot;session&quot;</code>）。</td>
<td>随用随取，跨文件、跨用例传递数据非常灵活。</td>
</tr>
<tr>
<td><strong>优点</strong></td>
<td><strong>效率高</strong>。设置 <code>scope=&quot;session&quot;</code> 后，跑1000条用例只登录一次，速度极快。</td>
<td><strong>解耦</strong>。用例 A 产生的数据，用例 B、C、D 都能读取，不受执行顺序的严格限制（只要文件里有）。</td>
</tr>
</tbody></table>
<hr>
<p>现在把 <strong>“登录”</strong> 这一步，从普通用例升级为 <strong>Fixture（前置固件）</strong>。这样做的目的是：<strong>实现一次登录，全局复用</strong>，而不是每跑一条测试用例都重新登录一遍（太慢了）。</p>
<h2 id="3-引入-Conftest-与-Fixture"><a href="#3-引入-Conftest-与-Fixture" class="headerlink" title="3.引入 Conftest 与 Fixture"></a>3.引入 Conftest 与 Fixture</h2><p>现在把登录逻辑迁移到 <code>conftest.py</code> 中。</p>
<p><strong>操作步骤：</strong></p>
<ol>
<li>在项目根目录（<code>api_test/</code>）下新建文件 <code>conftest.py</code>（文件名必须是这个，Pytest 才能自动识别）。</li>
<li>写入以下代码：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pytest<br><span class="hljs-keyword">from</span> common.request_util <span class="hljs-keyword">import</span> RequestUtil<br><span class="hljs-keyword">from</span> utils.yaml_util <span class="hljs-keyword">import</span> YamlUtil<br><span class="hljs-keyword">from</span> utils.extract_util <span class="hljs-keyword">import</span> ExtractUtil<br><br><span class="hljs-comment"># 在整个测试会话期间只执行一次 并且自动执行</span><br><span class="hljs-meta">@pytest.fixture(<span class="hljs-params">scope=<span class="hljs-string">&quot;session&quot;</span>, autouse=<span class="hljs-literal">True</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_database_clear</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    (可选) 比如每次跑测试前，先清理一下extract.yaml</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    ExtractUtil().clear_extract_yaml()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n--- 全局前置：清理临时数据文件 ---&quot;</span>)<br><br><span class="hljs-comment"># 全局登录</span><br><span class="hljs-meta">@pytest.fixture(<span class="hljs-params">scope=<span class="hljs-string">&quot;session&quot;</span>, autouse=<span class="hljs-literal">True</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">login_fixture</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    全局登录 Fixture</span><br><span class="hljs-string">    scope=&quot;session&quot;: 整个测试会话只执行一次</span><br><span class="hljs-string">    autouse=True: 自动应用，不需要在每个用例里手动调用</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n--- 全局前置：开始执行登录 ---&quot;</span>)<br>    <br>    <span class="hljs-comment"># 1. 直接读取登录数据（这里可以写死管理员账号，或者读取配置文件）</span><br>    <span class="hljs-comment"># 实际项目中，通常有一个专门的管理员账号用于测试</span><br>    data = &#123;<span class="hljs-string">&quot;username&quot;</span>: <span class="hljs-string">&quot;testuser&quot;</span>, <span class="hljs-string">&quot;password&quot;</span>: <span class="hljs-string">&quot;123456&quot;</span>&#125;<br>    <br>    <span class="hljs-comment"># 2. 发送请求</span><br>    req = RequestUtil()<br>    <span class="hljs-comment"># 注意：这里还没修改 RequestUtil 自动带 Token 的逻辑，所以登录本身不需要 Token</span><br>    res = req.send_request(method=<span class="hljs-string">&quot;post&quot;</span>, url=<span class="hljs-string">&quot;/auth/login&quot;</span>, json=data)<br>    result = res.json()<br>    <br>    <span class="hljs-comment"># 3. 提取 Token</span><br>    <span class="hljs-keyword">if</span> res.status_code == <span class="hljs-number">200</span> <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;data&quot;</span> <span class="hljs-keyword">in</span> result:<br>        token = result[<span class="hljs-string">&#x27;data&#x27;</span>][<span class="hljs-string">&#x27;token&#x27;</span>]<br>        ExtractUtil().write_extract_yaml(&#123;<span class="hljs-string">&quot;access_token&quot;</span>: token&#125;)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;--- 全局登录成功，Token 已保存 ---&quot;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;--- 全局登录失败: <span class="hljs-subst">&#123;result&#125;</span> ---&quot;</span>)<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="4-调整-RequestUtil"><a href="#4-调整-RequestUtil" class="headerlink" title="4.调整 RequestUtil"></a>4.调整 RequestUtil</h2><p>既然 Token 已经通过 Fixture 在测试开始的一瞬间就拿到了 <code>extract.yaml</code> 里，那么后续所有的接口（购物车、订单），在发送请求时，都应该<strong>自动</strong>去文件里把这个 Token 读出来，放到 Header 里。需要修改 <code>common/request_util.py</code>。即<strong>自动化鉴权</strong>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># common/request_util.py (修改版)</span><br><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> common.logger_util <span class="hljs-keyword">import</span> logger<br><span class="hljs-keyword">from</span> utils.yaml_util <span class="hljs-keyword">import</span> YamlUtil<br><span class="hljs-keyword">from</span> utils.extract_util <span class="hljs-keyword">import</span> ExtractUtil  <span class="hljs-comment"># 导入提取工具</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestUtil</span>:<br>    sess = requests.Session()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">send_request</span>(<span class="hljs-params">self, method, url, **kwargs</span>):<br>        <br>        config = YamlUtil.read_config()<br>        base_url = config[<span class="hljs-string">&#x27;env&#x27;</span>][<span class="hljs-string">&#x27;base_url&#x27;</span>]<br>        full_url = base_url + url<br><br>        <span class="hljs-comment"># --- 新增逻辑：自动添加 Token ---</span><br>        <span class="hljs-comment"># 如果不是登录或注册接口，都需要带 Token</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;/auth/login&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> url <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;/auth/register&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> url:<br>            <span class="hljs-comment"># 从 extract.yaml 读取 token</span><br>            token = ExtractUtil().read_extract_yaml(<span class="hljs-string">&quot;access_token&quot;</span>)<br>            <span class="hljs-comment"># 构造 headers</span><br>            headers = kwargs.get(<span class="hljs-string">&quot;headers&quot;</span>, &#123;&#125;) <span class="hljs-comment"># 获取原有的 headers，如果没有就新建空字典</span><br>            <span class="hljs-keyword">if</span> token:<br>                headers.update(&#123;<span class="hljs-string">&quot;Authorization&quot;</span>: <span class="hljs-string">f&quot;Bearer <span class="hljs-subst">&#123;token&#125;</span>&quot;</span>&#125;)<br>            kwargs[<span class="hljs-string">&quot;headers&quot;</span>] = headers <span class="hljs-comment"># 重新赋值回去</span><br>        <span class="hljs-comment"># -------------------------------</span><br><br>        method = method.lower()<br>        logger.info(<span class="hljs-string">&quot;----------------------------------&quot;</span>)<br>        logger.info(<span class="hljs-string">f&quot;接口请求开始 &gt;&gt;&gt;&quot;</span>)<br>        logger.info(<span class="hljs-string">f&quot;请求地址: <span class="hljs-subst">&#123;full_url&#125;</span>&quot;</span>)<br>        <br>        <span class="hljs-comment"># 打印一下 Headers 确认 Token 是否带上了</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;headers&quot;</span> <span class="hljs-keyword">in</span> kwargs:<br>            logger.info(<span class="hljs-string">f&quot;请求头: <span class="hljs-subst">&#123;kwargs[<span class="hljs-string">&#x27;headers&#x27;</span>]&#125;</span>&quot;</span>)<br><br>        <span class="hljs-comment"># ... (后续代码不变) ...</span><br>        <span class="hljs-keyword">try</span>:<br>            res = RequestUtil.sess.request(method=method, url=full_url, **kwargs)<br>        <span class="hljs-comment"># ... (后续代码不变) ...</span><br></code></pre></td></tr></table></figure>

<hr>
<h2 id="5-验证升级结果"><a href="#5-验证升级结果" class="headerlink" title="5.验证升级结果"></a>5.验证升级结果</h2><p>现在不需要显式地去运行登录用例了，可以直接去测一个<strong>需要权限</strong>的接口，比如**“获取购物车”**。如果能获取成功，说明 <code>conftest.py</code> 里的登录生效了，且 <code>RequestUtil</code> 自动带上了 Token。</p>
<p><strong>操作：</strong></p>
<ol>
<li>在 <code>test_cases</code> 下新建 <code>test_cart</code> 目录。</li>
<li>新建 <code>test_cart.py</code>：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pytest<br><span class="hljs-keyword">import</span> allure<br><span class="hljs-keyword">from</span> common.request_util <span class="hljs-keyword">import</span> RequestUtil<br><br><span class="hljs-meta">@allure.feature(<span class="hljs-params"><span class="hljs-string">&quot;购物车模块&quot;</span></span>)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">TestCart</span>:<br><br><span class="hljs-meta">    @allure.story(<span class="hljs-params"><span class="hljs-string">&quot;查看购物车&quot;</span></span>)</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_get_cart</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># 注意：这里并没有写登录代码，也没有手动传 Token</span><br>        req = RequestUtil()<br>        res = req.send_request(method=<span class="hljs-string">&quot;get&quot;</span>, url=<span class="hljs-string">&quot;/cart&quot;</span>)<br>        <br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\n购物车返回:&quot;</span>, res.json())<br>        <br>        <span class="hljs-keyword">assert</span> res.status_code == <span class="hljs-number">200</span><br>        <span class="hljs-keyword">assert</span> <span class="hljs-string">&quot;data&quot;</span> <span class="hljs-keyword">in</span> res.json()<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pytest test_cases/test_cart/test_cart.py -vs<br></code></pre></td></tr></table></figure>

<hr>
<h1 id="Allure报告"><a href="#Allure报告" class="headerlink" title="Allure报告"></a>Allure报告</h1><p>之前安装的 allure-pytest 只是一个插件。它的作用是把测试执行的过程记录下来，生成一堆 .json 和 .txt 的源数据文件存放于 .&#x2F;reports&#x2F;temp 目录。需要一个<strong>Allure 命令行工具（Allure Commandline）</strong>，把它“渲染”成漂亮的 HTML 网页.</p>
<p><strong>先跑一遍测试</strong>（确保 <code>./reports/temp</code> 下有数据）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pytest<br></code></pre></td></tr></table></figure>

<p><em>(因为在 pytest.ini 配置了 <code>--alluredir=./reports/temp</code>，所以数据会自动生成到这里)</em></p>
<p>然后启动 Allure 服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">allure serve ./reports/temp<br></code></pre></td></tr></table></figure>

<p><strong>预期结果：</strong></p>
<ul>
<li>执行命令后，它会自动启动一个临时的 Web 服务，并自动打开你的默认浏览器。将看到一张非常绚丽的图标（Allure 仪表盘）。</li>
</ul>
<hr>
<h2 id="看懂-Allure-报告"><a href="#看懂-Allure-报告" class="headerlink" title="看懂 Allure 报告"></a>看懂 Allure 报告</h2><p>在报告页面中，重点关注以下几个部分：</p>
<ol>
<li><strong>Suites (套件)</strong>：<ul>
<li>这里能看到 <code>test_cases</code> 目录结构。</li>
<li>点开 <code>test_auth</code> -&gt; <code>test_login</code>，能看到用例的详细执行步骤。</li>
</ul>
</li>
<li><strong>Behaviors (功能)</strong>：<ul>
<li>在代码里写的 <code>@allure.feature</code> 和 <code>@allure.story</code> 体现</li>
<li>这里会按照“用户认证模块” -&gt; “用户登录接口”这种业务层级来展示，产品经理也能看懂。</li>
</ul>
</li>
<li><strong>Graphs (图表)</strong>：<ul>
<li>展示测试通过率、耗时趋势等。</li>
</ul>
</li>
</ol>
<hr>
<h2 id="给报告加点料"><a href="#给报告加点料" class="headerlink" title="给报告加点料"></a>给报告加点料</h2><p>为了让报告更详细，可以把“请求”和“响应”的详细信息也挂载到报告上。</p>
<p><strong>修改 <code>common/request_util.py</code></strong>，利用 <code>allure.attach</code> 功能：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> allure <span class="hljs-comment"># 记得导入</span><br><br><span class="hljs-comment"># ... 在 RequestUtil 类的 send_request 方法中 ...</span><br><br>    <span class="hljs-comment"># 在 logger.info 打印完日志后，顺便加到 allure 报告里</span><br>    logger.info(<span class="hljs-string">f&quot;接口请求开始 &gt;&gt;&gt;&quot;</span>)<br>    <br>    <span class="hljs-comment"># --- 新增：将请求信息展示在 Allure 报告中 ---</span><br>    allure.attach(<span class="hljs-string">f&quot;URL: <span class="hljs-subst">&#123;full_url&#125;</span>\nMethod: <span class="hljs-subst">&#123;method&#125;</span>\nHeaders: <span class="hljs-subst">&#123;kwargs.get(<span class="hljs-string">&#x27;headers&#x27;</span>)&#125;</span>\nBody: <span class="hljs-subst">&#123;kwargs.get(<span class="hljs-string">&#x27;json&#x27;</span>)&#125;</span>&quot;</span>, <br>                  name=<span class="hljs-string">&quot;请求信息&quot;</span>, <br>                  attachment_type=allure.attachment_type.TEXT)<br>    <span class="hljs-comment"># ----------------------------------------</span><br><br>    <span class="hljs-keyword">try</span>:<br>        res = RequestUtil.sess.request(method=method, url=full_url, **kwargs)<br>        <br>        <span class="hljs-comment"># --- 新增：将响应信息展示在 Allure 报告中 ---</span><br>        allure.attach(<span class="hljs-string">f&quot;Status: <span class="hljs-subst">&#123;res.status_code&#125;</span>\nResponse: <span class="hljs-subst">&#123;res.text&#125;</span>&quot;</span>, <br>                      name=<span class="hljs-string">&quot;响应信息&quot;</span>, <br>                      attachment_type=allure.attachment_type.TEXT)<br>        <span class="hljs-comment"># ----------------------------------------</span><br>        <br>        <span class="hljs-keyword">return</span> res<br></code></pre></td></tr></table></figure>

<ol>
<li><code>pytest</code> (重新跑数据)</li>
<li><code>allure serve ./reports/temp</code> (重新渲染)</li>
</ol>
<p>现在点开报告里的用例，会发现每一步都有了“请求信息”和“响应信息”的附件，排查问题非常方便！</p>
<hr>
<h1 id="YAML热加载"><a href="#YAML热加载" class="headerlink" title="YAML热加载"></a>YAML热加载</h1><blockquote>
<p>痛点：有些数据不能写死。</p>
<p>比如【注册接口】，在 YAML 里写死 username: test01，第一次跑成功了，第二次跑就会报错“用户名已存在”。</p>
<p>问： “自动化测试数据怎么保证每次运行都有效？怎么生成随机数据？”</p>
</blockquote>
<p>现在就给框架装上**“热加载机制” (Hot-Loader)**，让 YAML 支持调用 Python 函数（如生成随机手机号）。目标是能在 YAML 里这样写：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">username:</span> <span class="hljs-string">&quot;test_$&#123;get_random_number()&#125;&quot;</span>  <span class="hljs-comment"># 自动替换成 test_8273</span><br><span class="hljs-attr">email:</span> <span class="hljs-string">&quot;$&#123;get_random_email()&#125;&quot;</span>           <span class="hljs-comment"># 自动替换成随机邮箱</span><br></code></pre></td></tr></table></figure>

<h2 id="1-编写调试函数-DebugTalk"><a href="#1-编写调试函数-DebugTalk" class="headerlink" title="1. 编写调试函数 (DebugTalk)"></a>1. 编写调试函数 (DebugTalk)</h2><p>在 <code>utils</code> 下新建 <code>debug_talk.py</code>，专门存放这些辅助生成的函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">from</span> faker <span class="hljs-keyword">import</span> Faker<br><br><span class="hljs-comment"># 初始化 Faker (设置为中文)</span><br>f = Faker(locale=<span class="hljs-string">&#x27;zh_CN&#x27;</span>)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DebugTalk</span>:<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_random_number</span>(<span class="hljs-params">self, min_val=<span class="hljs-number">1000</span>, max_val=<span class="hljs-number">9999</span></span>):<br>        <span class="hljs-string">&quot;&quot;&quot;生成随机数&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(random.randint(<span class="hljs-built_in">int</span>(min_val), <span class="hljs-built_in">int</span>(max_val)))<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_random_email</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;生成随机邮箱&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> f.email()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_random_name</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;生成随机姓名&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> f.name()<br></code></pre></td></tr></table></figure>

<h2 id="2-升级-YamlUtil-实现“热替换”"><a href="#2-升级-YamlUtil-实现“热替换”" class="headerlink" title="2. 升级 YamlUtil 实现“热替换”"></a>2. 升级 YamlUtil 实现“热替换”</h2><p>修改 <code>utils/yaml_util.py</code>，让它在读取 YAML 时，如果发现 <code>$&#123;func()&#125;</code> 这种格式，就自动去执行函数并替换。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># utils/yaml_util.py (修改版)</span><br><br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> yaml<br><span class="hljs-keyword">from</span> utils.debug_talk <span class="hljs-keyword">import</span> DebugTalk  <span class="hljs-comment"># 导入刚才写的工具类</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">YamlUtil</span>:<br>    <span class="hljs-comment"># ... (前面的代码不变) ...</span><br><br><span class="hljs-meta">    @staticmethod</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_test_data</span>(<span class="hljs-params">yaml_name</span>):<br>        data_path = os.path.join(YamlUtil.ROOT_PATH, <span class="hljs-string">&quot;data&quot;</span>, yaml_name)<br>        <br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(data_path):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;文件不存在: <span class="hljs-subst">&#123;data_path&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">return</span> []<br><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(data_path, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>                value = yaml.safe_load(f)<br>                <br>                <span class="hljs-comment"># --- 新增：热加载替换逻辑 ---</span><br>                <span class="hljs-comment"># 将 dict 转为 str，方便做全局替换</span><br>                str_data = <span class="hljs-built_in">str</span>(value)<br>                <br>                <span class="hljs-comment"># 遍历 DebugTalk 里的所有方法</span><br>                obj = DebugTalk()<br>                <span class="hljs-comment"># 获取所有非魔法方法（即不以__开头的方法）</span><br>                <span class="hljs-keyword">for</span> method <span class="hljs-keyword">in</span> <span class="hljs-built_in">dir</span>(obj):<br>                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> method.startswith(<span class="hljs-string">&quot;__&quot;</span>):<br>                        <span class="hljs-comment"># 构造占位符，例如 $&#123;get_random_number()&#125;</span><br>                        placeholder = <span class="hljs-string">&quot;$&#123;&quot;</span> + method + <span class="hljs-string">&quot;()&#125;&quot;</span><br>                        <br>                        <span class="hljs-keyword">if</span> placeholder <span class="hljs-keyword">in</span> str_data:<br>                            <span class="hljs-comment"># 反射方式：动态获取方法</span><br>                            func = <span class="hljs-built_in">getattr</span>(obj, method)<br>                            <span class="hljs-comment"># 执行函数 </span><br>                            real_value = func()<br>                            <span class="hljs-comment"># 替换字符串（注意：这里简单的替换只能处理无参函数，带参稍微复杂点）</span><br>                            str_data = str_data.replace(placeholder, <span class="hljs-built_in">str</span>(real_value))<br>                <br>                <span class="hljs-comment"># 替换完后再转回 dict</span><br>                <span class="hljs-comment"># 注意：eval有安全风险，但在测试框架内部使用是通用的做法</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">eval</span>(str_data)<br>                <span class="hljs-comment"># -------------------------</span><br>                <br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;读取测试数据失败: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">return</span> []<br></code></pre></td></tr></table></figure>

<h2 id="3-注册测试"><a href="#3-注册测试" class="headerlink" title="3.注册测试"></a>3.注册测试</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># data/register_data.yaml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">case_name:</span> <span class="hljs-string">&quot;新用户注册测试&quot;</span><br>  <span class="hljs-attr">request:</span><br>    <span class="hljs-attr">method:</span> <span class="hljs-string">&quot;post&quot;</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">&quot;/auth/register&quot;</span><br>    <span class="hljs-attr">json:</span><br>      <span class="hljs-comment"># 这里必须用热加载，因为不能重复注册同一个名字</span><br>      <span class="hljs-attr">username:</span> <span class="hljs-string">&quot;user_$&#123;get_random_number()&#125;&quot;</span><br>      <span class="hljs-attr">email:</span> <span class="hljs-string">&quot;$&#123;get_random_email()&#125;&quot;</span><br>      <span class="hljs-attr">password:</span> <span class="hljs-string">&quot;123456&quot;</span><br>  <span class="hljs-attr">validate:</span><br>    <span class="hljs-attr">status_code:</span> <span class="hljs-number">201</span><br>    <span class="hljs-attr">message:</span> <span class="hljs-string">&quot;注册成功&quot;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pytest<br><span class="hljs-keyword">import</span> allure<br><span class="hljs-keyword">from</span> common.request_util <span class="hljs-keyword">import</span> RequestUtil<br><span class="hljs-keyword">from</span> utils.yaml_util <span class="hljs-keyword">import</span> YamlUtil<br><span class="hljs-keyword">from</span> common.db_util <span class="hljs-keyword">import</span> DBUtil<br><br><span class="hljs-meta">@allure.epic(<span class="hljs-params"><span class="hljs-string">&quot;Flask商城接口测试&quot;</span></span>)</span><br><span class="hljs-meta">@allure.feature(<span class="hljs-params"><span class="hljs-string">&quot;用户注册模块&quot;</span></span>)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">TestRegister</span>:<br><br>    data_list = YamlUtil.read_test_data(<span class="hljs-string">&#x27;register_data.yaml&#x27;</span>)<br><br><span class="hljs-meta">    @allure.story(<span class="hljs-params"><span class="hljs-string">&quot;用户注册接口&quot;</span></span>)</span><br><span class="hljs-meta">    @pytest.mark.parametrize(<span class="hljs-params"><span class="hljs-string">&quot;case_info&quot;</span>, data_list</span>)</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_register</span>(<span class="hljs-params">self, case_info</span>):<br>        url = case_info[<span class="hljs-string">&#x27;request&#x27;</span>][<span class="hljs-string">&#x27;url&#x27;</span>]<br>        method = case_info[<span class="hljs-string">&#x27;request&#x27;</span>][<span class="hljs-string">&#x27;method&#x27;</span>]<br>        json_data = case_info[<span class="hljs-string">&#x27;request&#x27;</span>][<span class="hljs-string">&#x27;json&#x27;</span>]<br><br>        <span class="hljs-comment"># 发送请求</span><br>        req = RequestUtil()<br>        res = req.send_request(method=method, url=url, json=json_data)<br>        result = res.json()<br><br>        <span class="hljs-comment"># 断言验证结果</span><br>        <span class="hljs-keyword">assert</span> res.status_code == case_info[<span class="hljs-string">&#x27;validate&#x27;</span>][<span class="hljs-string">&#x27;status_code&#x27;</span>]<br>        <span class="hljs-keyword">assert</span> case_info[<span class="hljs-string">&#x27;validate&#x27;</span>][<span class="hljs-string">&#x27;message&#x27;</span>] <span class="hljs-keyword">in</span> result[<span class="hljs-string">&#x27;message&#x27;</span>]<br></code></pre></td></tr></table></figure>

<hr>
<h1 id="测试实战业务（添加-查看-下单）"><a href="#测试实战业务（添加-查看-下单）" class="headerlink" title="测试实战业务（添加 -&gt; 查看 -&gt; 下单）"></a>测试实战业务（添加 -&gt; 查看 -&gt; 下单）</h1><p>现在来写一个**“全链路业务场景”**。<strong>场景</strong>：注册一个新用户 -&gt; 用新用户登录 -&gt; 添加商品到购物车 -&gt; 下单。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># data/shop_flow_data.yaml</span><br><span class="hljs-comment"># 这里不需要注册和登录了，因为 pytest 会自动执行 conftest 里的登录</span><br><br><span class="hljs-bullet">-</span> <span class="hljs-attr">case_name:</span> <span class="hljs-string">&quot;01_添加商品到购物车&quot;</span><br>  <span class="hljs-attr">request:</span><br>    <span class="hljs-attr">method:</span> <span class="hljs-string">&quot;post&quot;</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">&quot;/cart&quot;</span><br>    <span class="hljs-attr">json:</span><br>      <span class="hljs-attr">product_id:</span> <span class="hljs-number">1</span><br>      <span class="hljs-attr">quantity:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">validate:</span><br>    <span class="hljs-attr">status_code:</span> <span class="hljs-number">200</span><br>    <span class="hljs-attr">message:</span> <span class="hljs-string">&quot;操作成功&quot;</span><br><br><span class="hljs-bullet">-</span> <span class="hljs-attr">case_name:</span> <span class="hljs-string">&quot;02_查看购物车&quot;</span><br>  <span class="hljs-attr">request:</span><br>    <span class="hljs-attr">method:</span> <span class="hljs-string">&quot;get&quot;</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">&quot;/cart&quot;</span><br>  <span class="hljs-attr">validate:</span><br>    <span class="hljs-attr">status_code:</span> <span class="hljs-number">200</span><br><br><span class="hljs-bullet">-</span> <span class="hljs-attr">case_name:</span> <span class="hljs-string">&quot;03_创建订单&quot;</span><br>  <span class="hljs-attr">request:</span><br>    <span class="hljs-attr">method:</span> <span class="hljs-string">&quot;post&quot;</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">&quot;/orders&quot;</span><br>    <span class="hljs-attr">json:</span><br>      <span class="hljs-attr">shipping_address:</span> <span class="hljs-string">&quot;江苏师范大学&quot;</span><br>  <span class="hljs-attr">validate:</span><br>    <span class="hljs-attr">status_code:</span> <span class="hljs-number">201</span><br></code></pre></td></tr></table></figure>

<p>在 <code>test_cases</code> 下新建 <code>test_order</code> 目录，然后新建 <code>test_order_flow.py</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pytest<br><span class="hljs-keyword">import</span> allure<br><span class="hljs-keyword">from</span> common.request_util <span class="hljs-keyword">import</span> RequestUtil<br><span class="hljs-keyword">from</span> utils.yaml_util <span class="hljs-keyword">import</span> YamlUtil<br><br><span class="hljs-meta">@allure.epic(<span class="hljs-params"><span class="hljs-string">&quot;Flask商城交易系统&quot;</span></span>)</span><br><span class="hljs-meta">@allure.feature(<span class="hljs-params"><span class="hljs-string">&quot;订单全链路测试&quot;</span></span>)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">TestOrderFlow</span>:<br>    <span class="hljs-comment"># 读取数据</span><br>    data_list = YamlUtil.read_test_data(<span class="hljs-string">&quot;shop_flow_data.yaml&quot;</span>)<br><br><span class="hljs-meta">    @allure.story(<span class="hljs-params"><span class="hljs-string">&quot;购物下单流程&quot;</span></span>)</span><br><span class="hljs-meta">    @pytest.mark.parametrize(<span class="hljs-params"><span class="hljs-string">&quot;case_info&quot;</span>, data_list</span>)</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_shop_process</span>(<span class="hljs-params">self, case_info</span>):<br><br>        url = case_info[<span class="hljs-string">&#x27;request&#x27;</span>][<span class="hljs-string">&#x27;url&#x27;</span>]<br>        method = case_info[<span class="hljs-string">&#x27;request&#x27;</span>][<span class="hljs-string">&#x27;method&#x27;</span>]<br>        json_data = case_info[<span class="hljs-string">&#x27;request&#x27;</span>].get(<span class="hljs-string">&#x27;json&#x27;</span>)<br><br>        <span class="hljs-comment"># 发送请求 (RequestUtil 会自动带上 conftest 里登录好的 Token)</span><br>        req = RequestUtil()<br>        res = req.send_request(method=method, url=url, json=json_data)<br><br>        <span class="hljs-comment"># 断言</span><br>        <span class="hljs-keyword">assert</span> res.status_code == case_info[<span class="hljs-string">&#x27;validate&#x27;</span>][<span class="hljs-string">&#x27;status_code&#x27;</span>]<br></code></pre></td></tr></table></figure>

<hr>
<h1 id="数据库验证"><a href="#数据库验证" class="headerlink" title="数据库验证"></a>数据库验证</h1><p>我们现在的目标是：<strong>在 Python 代码里直接连库查询，对比 API 返回结果与数据库实际存储结果。</strong></p>
<p>由于 Flask 应用使用的是 <strong>SQLite</strong>，直接使用 Python 自带的 <code>sqlite3</code> 库封装一个工具类。虽然生产环境多用 MySQL，但封装逻辑是一模一样的,封装了 DBUtil，底层换成 PyMySQL 就能连 MySQL。</p>
<hr>
<h2 id="1-配置数据库路径-Config"><a href="#1-配置数据库路径-Config" class="headerlink" title="1.配置数据库路径 (Config)"></a>1.配置数据库路径 (Config)</h2><p>需要在 <code>config.yaml</code> 里告诉测试框架，数据库文件在哪里。修改 config&#x2F;config.yaml，增加数据库配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># config/config.yaml</span><br><br><span class="hljs-comment"># 当前环境配置</span><br><span class="hljs-attr">env:</span><br>  <span class="hljs-attr">base_url:</span> <span class="hljs-string">&quot;http://localhost:5000/api&quot;</span>  <span class="hljs-comment"># 这里根据API文档的基础信息填写</span><br><br>  <span class="hljs-comment"># 如果有数据库配置也可以放这里</span><br>  <span class="hljs-attr">db_path:</span> <span class="hljs-string">&quot;D:\\Workspace\\flask-project\\flask_app\\instance\\app.db&quot;</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>：Windows 路径分隔符需要用双斜杠 <code>\\</code> 转义。需要找到 Flask 项目生成的那个 <code>.db</code> 文件。</p>
</blockquote>
<hr>
<h2 id="2-封装数据库工具类-DBUtil"><a href="#2-封装数据库工具类-DBUtil" class="headerlink" title="2.封装数据库工具类 (DBUtil)"></a>2.封装数据库工具类 (DBUtil)</h2><p>在 <code>common</code> 目录下新建 <code>db_util.py</code>。这个类负责连接数据库、执行 SQL、返回字典格式的数据。在 common 目录下新建 db_util.py，写入：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> sqlite3<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> utils.yaml_util <span class="hljs-keyword">import</span> YamlUtil<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DBUtil</span>:<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># 1. 从配置文件读取数据库路径</span><br>        config = YamlUtil.read_config()<br>        <span class="hljs-variable language_">self</span>.db_path = config[<span class="hljs-string">&#x27;env&#x27;</span>][<span class="hljs-string">&#x27;db_path&#x27;</span>]<br>        <br>        <span class="hljs-comment"># 检查文件是否存在，防止报错一脸懵</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(<span class="hljs-variable language_">self</span>.db_path):<br>            <span class="hljs-keyword">raise</span> FileNotFoundError(<span class="hljs-string">f&quot;数据库文件未找到，请检查路径: <span class="hljs-subst">&#123;self.db_path&#125;</span>&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query_one</span>(<span class="hljs-params">self, sql</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        查询单条记录</span><br><span class="hljs-string">        :return: 字典格式 &#123;&#x27;id&#x27;: 1, &#x27;username&#x27;: &#x27;test&#x27;&#125;</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 建立数据库连接</span><br>        conn = sqlite3.connect(<span class="hljs-variable language_">self</span>.db_path)<br>        <br>        <span class="hljs-comment"># 关键点：设置 row_factory，改变了查询结果的返回格式 让查询结果返回一个像字典一样可以按列名访问的对象,而不是元组 (Tuple)</span><br>        <span class="hljs-comment"># 这样我们在断言时可以用 res[&#x27;username&#x27;]，可读性更强</span><br>        conn.row_factory = sqlite3.Row <br>        <br>        <span class="hljs-comment"># 创建游标对象 游标是执行 SQL 命令的&quot;指针&quot;或&quot;手柄&quot;</span><br>        cursor = conn.cursor()<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-comment"># 执行 SQL 语句</span><br>            cursor.execute(sql)<br>            row = cursor.fetchone() <span class="hljs-comment"># 获取一条 &lt;class &#x27;sqlite3.Row&#x27;&gt;</span><br>            <br>            <span class="hljs-comment"># 将 sqlite3.Row 对象转为普通字典</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">dict</span>(row) <span class="hljs-keyword">if</span> row <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;SQL执行报错: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">finally</span>:<br>            cursor.close()<br>            conn.close()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">query_all</span>(<span class="hljs-params">self, sql</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;查询多条记录&quot;&quot;&quot;</span><br>        conn = sqlite3.connect(<span class="hljs-variable language_">self</span>.db_path)<br>        conn.row_factory = sqlite3.Row<br>        cursor = conn.cursor()<br>        <span class="hljs-keyword">try</span>:<br>            cursor.execute(sql)<br>            rows = cursor.fetchall()<br>            <span class="hljs-comment"># 转为列表套字典</span><br>            <span class="hljs-keyword">return</span> [<span class="hljs-built_in">dict</span>(row) <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> rows] <span class="hljs-keyword">if</span> rows <span class="hljs-keyword">else</span> []<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;SQL执行报错: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br>            <span class="hljs-keyword">return</span> []<br>        <span class="hljs-keyword">finally</span>:<br>            cursor.close()<br>            conn.close()<br><br><span class="hljs-comment"># 调试代码</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    <span class="hljs-comment"># 你可以先在 Flask 里注册一个用户 &#x27;testuser&#x27;，然后运行这个文件试试</span><br>    db = DBUtil()<br>    user = db.query_one(<span class="hljs-string">&quot;SELECT * FROM user WHERE username=&#x27;testuser&#x27;&quot;</span>)<br>    <span class="hljs-built_in">print</span>(user)<br></code></pre></td></tr></table></figure>

<hr>
<h2 id="3-在测试用例中加入数据库断言"><a href="#3-在测试用例中加入数据库断言" class="headerlink" title="3.在测试用例中加入数据库断言"></a>3.在测试用例中加入数据库断言</h2><p>拿 “注册接口” 来做演示。</p>
<p>逻辑：</p>
<ol>
<li>API 发送注册请求。</li>
<li>断言 HTTP 状态码 201。</li>
<li><strong>(新增)</strong> 连接数据库，<code>SELECT * FROM user WHERE username = &#39;刚刚注册的名字&#39;</code>。</li>
<li><strong>(新增)</strong> 断言查询结果不为空，且邮箱字段与请求的一致。</li>
</ol>
<p>修改 test_cases&#x2F;test_auth&#x2F;test_register.py：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pytest<br><span class="hljs-keyword">import</span> allure<br><span class="hljs-keyword">from</span> common.request_util <span class="hljs-keyword">import</span> RequestUtil<br><span class="hljs-keyword">from</span> utils.yaml_util <span class="hljs-keyword">import</span> YamlUtil<br><span class="hljs-keyword">from</span> common.db_util <span class="hljs-keyword">import</span> DBUtil<br><br><span class="hljs-meta">@allure.epic(<span class="hljs-params"><span class="hljs-string">&quot;Flask商城接口测试&quot;</span></span>)</span><br><span class="hljs-meta">@allure.feature(<span class="hljs-params"><span class="hljs-string">&quot;用户注册模块&quot;</span></span>)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">TestRegister</span>:<br><br>    data_list = YamlUtil.read_test_data(<span class="hljs-string">&#x27;register_data.yaml&#x27;</span>)<br><br><span class="hljs-meta">    @allure.story(<span class="hljs-params"><span class="hljs-string">&quot;用户注册接口&quot;</span></span>)</span><br><span class="hljs-meta">    @pytest.mark.parametrize(<span class="hljs-params"><span class="hljs-string">&quot;case_info&quot;</span>, data_list</span>)</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_register</span>(<span class="hljs-params">self, case_info</span>):<br>        url = case_info[<span class="hljs-string">&#x27;request&#x27;</span>][<span class="hljs-string">&#x27;url&#x27;</span>]<br>        method = case_info[<span class="hljs-string">&#x27;request&#x27;</span>][<span class="hljs-string">&#x27;method&#x27;</span>]<br>        json_data = case_info[<span class="hljs-string">&#x27;request&#x27;</span>][<span class="hljs-string">&#x27;json&#x27;</span>]<br><br>        <span class="hljs-comment"># 发送请求</span><br>        req = RequestUtil()<br>        res = req.send_request(method=method, url=url, json=json_data)<br>        result = res.json()<br><br>        <span class="hljs-comment"># 断言验证结果</span><br>        <span class="hljs-keyword">assert</span> res.status_code == case_info[<span class="hljs-string">&#x27;validate&#x27;</span>][<span class="hljs-string">&#x27;status_code&#x27;</span>]<br>        <span class="hljs-keyword">assert</span> case_info[<span class="hljs-string">&#x27;validate&#x27;</span>][<span class="hljs-string">&#x27;message&#x27;</span>] <span class="hljs-keyword">in</span> result[<span class="hljs-string">&#x27;message&#x27;</span>]<br><br>        <span class="hljs-comment"># 数据库断言</span><br>        <span class="hljs-comment"># 在这里，json_data 已经是被 YamlUtil 替换过实际值的字典了，可以直接取！</span><br>        target_username = json_data[<span class="hljs-string">&#x27;username&#x27;</span>]<br>        target_email = json_data[<span class="hljs-string">&#x27;email&#x27;</span>]<br><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;正在数据库中查询用户: <span class="hljs-subst">&#123;target_username&#125;</span>&quot;</span>)<br>        sql = <span class="hljs-string">f&quot;SELECT * FROM user WHERE username = &#x27;<span class="hljs-subst">&#123;target_username&#125;</span>&#x27;&quot;</span><br><br>        db_res = DBUtil().query_one(sql)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;数据库查询结果: <span class="hljs-subst">&#123;db_res&#125;</span>&quot;</span>)<br>        allure.attach(<span class="hljs-built_in">str</span>(db_res), name=<span class="hljs-string">&quot;数据库查询结果&quot;</span>, attachment_type=allure.attachment_type.TEXT)<br><br>        <span class="hljs-comment"># 核心断言</span><br>        <span class="hljs-comment"># A. 断言数据存在</span><br>        <span class="hljs-keyword">assert</span> db_res <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>, <span class="hljs-string">&quot;数据库断言失败：未查询到用户信息&quot;</span><br>        <span class="hljs-comment"># B. 断言关键字段一致 (API 入参与 DB 落库一致)</span><br>        <span class="hljs-keyword">assert</span> db_res[<span class="hljs-string">&#x27;username&#x27;</span>] == target_username<br>        <span class="hljs-keyword">assert</span> db_res[<span class="hljs-string">&#x27;email&#x27;</span>] == target_email<br>        <span class="hljs-keyword">assert</span> db_res[<span class="hljs-string">&#x27;is_active&#x27;</span>] == <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pytest test_cases/test_auth/test_register.py -vs<br></code></pre></td></tr></table></figure>

<hr>
<h1 id="测试文件上传"><a href="#测试文件上传" class="headerlink" title="测试文件上传"></a>测试文件上传</h1><p>测试文件上传是 <strong>Requests 库的一个难点</strong>，因为YAML 只能存文本，存不了二进制文件。所以策略是：<strong>YAML 里存文件名，代码里读取文件并转换成二进制流。</strong></p>
<hr>
<h2 id="1-准备测试文件-Material"><a href="#1-准备测试文件-Material" class="headerlink" title="1.准备测试文件 (Material)"></a>1.准备测试文件 (Material)</h2><p>在项目根目录下新建一个 resources 目录，放一个 txt 文件。</p>
<hr>
<h2 id="2-编写上传测试数据-YAML"><a href="#2-编写上传测试数据-YAML" class="headerlink" title="2.编写上传测试数据 (YAML)"></a>2.编写上传测试数据 (YAML)</h2><p>在 data 目录下新建 upload_data.yaml。注意：这里的 data 字段不存 JSON，而是存文件的相对路径。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">- case_name: <span class="hljs-string">&quot;上传文本文件_成功&quot;</span><br>  request:<br>    method: <span class="hljs-string">&quot;post&quot;</span><br>    url: <span class="hljs-string">&quot;/files/upload&quot;</span><br>    <span class="hljs-comment"># 自定义字段，专门用来存文件名，这不是 requests 的标准参数，是我们自己定义的约定</span><br>    file_name: <span class="hljs-string">&quot;demo1.txt&quot;</span><br>    file_type: <span class="hljs-string">&quot;text/plain&quot;</span> <span class="hljs-comment"># 文件的 MIME 类型</span><br>  validate:<br>    status_code: <span class="hljs-number">201</span><br>    message: <span class="hljs-string">&quot;上传成功&quot;</span><br></code></pre></td></tr></table></figure>

<hr>
<h2 id="3-编写上传测试用例"><a href="#3-编写上传测试用例" class="headerlink" title="3.编写上传测试用例"></a>3.编写上传测试用例</h2><p>需要在 <code>TestUpload</code> 类里完成“从磁盘读取文件 -&gt; 组装成 files 参数”的过程。在 <code>test_cases</code> 下新建 <code>test_file</code> 目录，新建 <code>test_upload.py</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> pytest<br><span class="hljs-keyword">import</span> allure<br><span class="hljs-keyword">from</span> common.request_util <span class="hljs-keyword">import</span> RequestUtil<br><span class="hljs-keyword">from</span> utils.yaml_util <span class="hljs-keyword">import</span> YamlUtil<br><br><br><span class="hljs-meta">@allure.epic(<span class="hljs-params"><span class="hljs-string">&quot;Flask商城接口测试&quot;</span></span>)</span><br><span class="hljs-meta">@allure.feature(<span class="hljs-params"><span class="hljs-string">&quot;文件管理模块&quot;</span></span>)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">TestUpload</span>:<br>    data_list = YamlUtil.read_test_data(<span class="hljs-string">&quot;upload_data.yaml&quot;</span>)<br>    <span class="hljs-comment"># 获取项目根目录，方便拼接文件路径</span><br>    root_path = YamlUtil.ROOT_PATH<br><br><span class="hljs-meta">    @allure.story(<span class="hljs-params"><span class="hljs-string">&quot;文件上传接口&quot;</span></span>)</span><br><span class="hljs-meta">    @pytest.mark.parametrize(<span class="hljs-params"><span class="hljs-string">&quot;case_info&quot;</span>, data_list</span>)</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_upload</span>(<span class="hljs-params">self, case_info</span>):<br>        url = case_info[<span class="hljs-string">&#x27;request&#x27;</span>][<span class="hljs-string">&#x27;url&#x27;</span>]<br>        method = case_info[<span class="hljs-string">&#x27;request&#x27;</span>][<span class="hljs-string">&#x27;method&#x27;</span>]<br>        file_name = case_info[<span class="hljs-string">&#x27;request&#x27;</span>][<span class="hljs-string">&#x27;file_name&#x27;</span>]<br>        file_type = case_info[<span class="hljs-string">&#x27;request&#x27;</span>][<span class="hljs-string">&#x27;file_type&#x27;</span>]<br><br>        <span class="hljs-comment"># --- 1. 拼接文件的绝对路径 ---</span><br>        <span class="hljs-comment"># 假设文件放在 resources 目录下</span><br>        file_path = os.path.join(<span class="hljs-variable language_">self</span>.root_path, <span class="hljs-string">&quot;resources&quot;</span>, file_name)<br><br>        <span class="hljs-comment"># --- 2. 核心：构建 files 参数 ---</span><br>        <span class="hljs-comment"># 语法: files = &#123;&#x27;参数名&#x27;: (&#x27;文件名&#x27;, open(文件路径, &#x27;rb&#x27;), &#x27;Content-Type&#x27;)&#125;</span><br>        <span class="hljs-comment"># &#x27;rb&#x27; 是以二进制只读模式打开，这非常重要！</span><br>        <span class="hljs-keyword">if</span> os.path.exists(file_path):<br>            file_data = <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">&#x27;rb&#x27;</span>)<br>            files = &#123;<br>                <span class="hljs-comment"># &quot;file&quot; - 对应接口的参数名</span><br>                <span class="hljs-string">&quot;file&quot;</span>: (file_name, file_data, file_type)<br>            &#125;<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">raise</span> FileNotFoundError(<span class="hljs-string">f&quot;测试文件不存在: <span class="hljs-subst">&#123;file_path&#125;</span>&quot;</span>)<br><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-comment"># --- 3. 发送请求 ---</span><br>            <span class="hljs-comment"># 注意：上传文件用 files 参数，不用 json 参数</span><br>            <span class="hljs-comment"># RequestUtil 的 send_request 需要能接收 **kwargs</span><br>            req = RequestUtil()<br>            res = req.send_request(method=method, url=url, files=files)<br>            result = res.json()<br><br>            <span class="hljs-comment"># --- 4. 断言 ---</span><br>            <span class="hljs-keyword">assert</span> res.status_code == case_info[<span class="hljs-string">&#x27;validate&#x27;</span>][<span class="hljs-string">&#x27;status_code&#x27;</span>]<br>            <span class="hljs-keyword">assert</span> result[<span class="hljs-string">&#x27;message&#x27;</span>] == case_info[<span class="hljs-string">&#x27;validate&#x27;</span>][<span class="hljs-string">&#x27;message&#x27;</span>]<br><br>        <span class="hljs-keyword">finally</span>:<br>            <span class="hljs-comment"># --- 5. 必须关闭文件流 ---</span><br>            <span class="hljs-comment"># 否则文件会被 Python 占用，导致无法删除或移动</span><br>            file_data.close()<br></code></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">pytest test_cases/test_file/test_upload.py -vs<br></code></pre></td></tr></table></figure>

<hr>
<h1 id="GitHub-Actions"><a href="#GitHub-Actions" class="headerlink" title="GitHub Actions"></a>GitHub Actions</h1><p>Jenkins 是“重型武器”，虽然企业用得多，但维护成本极高（尤其是国内网络环境下的插件依赖问题）。而 <strong>GitHub Actions</strong> 是<strong>云原生</strong>的，环境由微软提供，免去了所有 Docker、Java、插件安装的烦恼，是现在开源项目和个人简历项目的<strong>首选</strong>。</p>
<p><strong>只要你的代码能传到 GitHub，GitHub Actions 就能免费帮你跑测试。</strong></p>
<blockquote>
<p><strong>核心问题：</strong> GitHub 的服务器（Runner）在云端，它访问不到你<strong>本地电脑</strong>（Changhua, Taiwan）上运行的 <code>localhost:5000</code> Flask 服务。</p>
<p><strong>解决方案：</strong> 你必须把 <strong>Flask 商城应用的代码</strong> 也一并上传到 GitHub 仓库里。这样 GitHub Actions 在运行测试前，可以在云端先把 Flask 服务跑起来，然后再运行 Pytest 去测它。</p>
</blockquote>
<hr>
<h2 id="1-整理代码结构"><a href="#1-整理代码结构" class="headerlink" title="1.整理代码结构"></a>1.整理代码结构</h2><p>为了让 GitHub 既能跑服务，又能跑测试，建议你的仓库结构长这样（把 Flask 代码和测试代码放一起，或者清楚地分开）：</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs nix">my-project<span class="hljs-symbol">/</span><br>├── api_test<span class="hljs-symbol">/</span>           <span class="hljs-comment"># 你的自动化测试代码 (pytest, allure)</span><br>│   ├── common<span class="hljs-symbol">/</span><br>│   ├── test_cases<span class="hljs-symbol">/</span><br>│   ├── requirements.txt<br>│   └── ...<br>├── flask_app<span class="hljs-symbol">/</span>          <span class="hljs-comment"># 你的 Flask 商城代码 (也就是那个 app.py 所在的地方)</span><br>│   ├── app.py<br>│   ├── instance<span class="hljs-symbol">/</span>       <span class="hljs-comment"># 数据库文件 shop.db 最好也传上去，或者在 CI 里初始化</span><br>│   ├── requirements.txt <span class="hljs-comment"># Flask 的依赖</span><br>│   └── ...<br>└── ...<br></code></pre></td></tr></table></figure>

<p>操作：确保 GitHub 仓库里既有测试代码，也有 Flask 代码。</p>
<h2 id="2-配置-GitHub-Actions"><a href="#2-配置-GitHub-Actions" class="headerlink" title="2.配置 GitHub Actions"></a>2.配置 GitHub Actions</h2><p>在你的项目根目录下，创建目录和文件：</p>
<p>.github&#x2F;workflows&#x2F;api_ci.yml</p>
<p>以下内容填进去，包含了<strong>启动服务 -&gt; 跑测试 -&gt; 生成报告 -&gt; 发布报告</strong>的全流程：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">name:</span> <span class="hljs-string">API</span> <span class="hljs-string">Automated</span> <span class="hljs-string">Testing</span><br><br><span class="hljs-comment"># 触发机制：当代码 push 到 main 分支时自动运行</span><br><span class="hljs-attr">on:</span><br>  <span class="hljs-attr">push:</span><br>    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">&quot;main&quot;</span> ]<br>  <span class="hljs-attr">pull_request:</span><br>    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">&quot;main&quot;</span> ]<br><br><span class="hljs-comment"># 权限设置（为了后面发布 Allure 报告到 GitHub Pages）</span><br><span class="hljs-attr">permissions:</span><br>  <span class="hljs-attr">contents:</span> <span class="hljs-string">write</span><br>  <span class="hljs-attr">pages:</span> <span class="hljs-string">write</span><br>  <span class="hljs-attr">id-token:</span> <span class="hljs-string">write</span><br><br><span class="hljs-attr">jobs:</span><br>  <span class="hljs-attr">test:</span><br>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span><br><br>    <span class="hljs-attr">steps:</span><br>    <span class="hljs-comment"># 1. 拉取代码</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span><br>      <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v4</span><br><br>    <span class="hljs-comment"># 2. 安装 Python 环境</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Set</span> <span class="hljs-string">up</span> <span class="hljs-string">Python</span><br>      <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-python@v5</span><br>      <span class="hljs-attr">with:</span><br>        <span class="hljs-attr">python-version:</span> <span class="hljs-string">&#x27;3.10&#x27;</span><br><br>    <span class="hljs-comment"># 3. 安装依赖 (Flask 和 Pytest 的依赖都要装)</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">dependencies</span><br>      <span class="hljs-attr">run:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        python -m pip install --upgrade pip</span><br><span class="hljs-string">        # 安装 Flask 应用的依赖 (假设在 flask_app 目录下)</span><br><span class="hljs-string">        if [ -f flask_app/requirements.txt ]; then pip install -r flask_app/requirements.txt; fi</span><br><span class="hljs-string">        # 安装 测试框架 的依赖 (假设在 api_test 目录下)</span><br><span class="hljs-string">        if [ -f api_test/requirements.txt ]; then pip install -r api_test/requirements.txt; fi</span><br><span class="hljs-string">        # 补充安装 allure-pytest</span><br><span class="hljs-string">        pip install allure-pytest requests</span><br><span class="hljs-string"></span><br>    <span class="hljs-comment"># 4. 启动 Flask 服务</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Start</span> <span class="hljs-string">Flask</span> <span class="hljs-string">Application</span><br>      <span class="hljs-attr">run:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        cd flask_app</span><br><span class="hljs-string">        # 启动服务，把标准输出和错误输出都记下来</span><br><span class="hljs-string">        nohup python run.py &gt; flask.log 2&gt;&amp;1 &amp;</span><br><span class="hljs-string">        echo &quot;Flask is starting...&quot;</span><br><span class="hljs-string">        sleep 10 # 延长等待时间到 10 秒</span><br><span class="hljs-string"></span>        <br>        <span class="hljs-comment"># 检查服务是否真的活着</span><br>        <span class="hljs-string">if</span> <span class="hljs-string">curl</span> <span class="hljs-string">-s</span> <span class="hljs-string">http://127.0.0.1:5000/api/products</span> <span class="hljs-string">&gt;</span> <span class="hljs-string">/dev/null;</span> <span class="hljs-string">then</span><br>          <span class="hljs-string">echo</span> <span class="hljs-string">&quot;Flask is UP and Running!&quot;</span><br>        <span class="hljs-string">else</span><br>          <span class="hljs-string">echo</span> <span class="hljs-string">&quot;Flask failed to start!&quot;</span><br>          <span class="hljs-string">echo</span> <span class="hljs-string">&quot;====== FLASK LOG START ======&quot;</span><br>          <span class="hljs-string">cat</span> <span class="hljs-string">flask.log</span><br>          <span class="hljs-string">echo</span> <span class="hljs-string">&quot;====== FLASK LOG END ======&quot;</span><br>          <span class="hljs-string">exit</span> <span class="hljs-number">1</span> <span class="hljs-comment"># 强制失败，停止后续步骤</span><br>        <span class="hljs-string">fi</span><br><br>    <span class="hljs-comment"># 5. 运行 Pytest 测试</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">API</span> <span class="hljs-string">Tests</span><br>      <span class="hljs-attr">run:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        cd api_test</span><br><span class="hljs-string">        pytest -vs --alluredir=./allure-results --clean-alluredir</span><br><span class="hljs-string"></span>      <span class="hljs-attr">continue-on-error:</span> <span class="hljs-literal">true</span><br><br>    <span class="hljs-comment"># 6. 生成 Allure 报告</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Generate</span> <span class="hljs-string">Allure</span> <span class="hljs-string">Report</span><br>      <span class="hljs-attr">uses:</span> <span class="hljs-string">simple-elf/allure-report-action@master</span><br>      <span class="hljs-attr">if:</span> <span class="hljs-string">always()</span><br>      <span class="hljs-attr">with:</span><br>        <span class="hljs-attr">allure_results:</span> <span class="hljs-string">api_test/allure-results</span><br>        <span class="hljs-attr">allure_report:</span> <span class="hljs-string">allure-report</span><br><br>    <span class="hljs-comment"># 7. 发布报告到 GitHub Pages (高大上的功能)</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">Report</span> <span class="hljs-string">to</span> <span class="hljs-string">GitHub</span> <span class="hljs-string">Pages</span><br>      <span class="hljs-attr">uses:</span> <span class="hljs-string">peaceiris/actions-gh-pages@v3</span><br>      <span class="hljs-attr">if:</span> <span class="hljs-string">always()</span><br>      <span class="hljs-attr">with:</span><br>        <span class="hljs-attr">github_token:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.GITHUB_TOKEN</span> <span class="hljs-string">&#125;&#125;</span><br>        <span class="hljs-attr">publish_dir:</span> <span class="hljs-string">allure-report</span><br>        <span class="hljs-attr">publish_branch:</span> <span class="hljs-string">gh-pages</span><br></code></pre></td></tr></table></figure>

<h2 id="3-开启-GitHub-Pages"><a href="#3-开启-GitHub-Pages" class="headerlink" title="3.开启 GitHub Pages"></a>3.开启 GitHub Pages</h2><p>为了你能看到 Allure 的网页报告，需要在仓库设置里开一下权限：</p>
<ol>
<li>进入你的 GitHub 仓库页面。</li>
<li>点击 <strong>Settings (设置)</strong> -&gt; <strong>Pages</strong>。</li>
<li>在 <strong>Build and deployment</strong> 下：<ul>
<li><strong>Source</strong>: 选择 <code>Deploy from a branch</code>。</li>
<li><strong>Branch</strong>: 选择 <code>gh-pages</code> (如果下拉菜单没有，说明 Action 还没跑，可以先不管，等第一次跑完会自动创建)。</li>
<li>folder 选择 <code>/(root)</code>。</li>
</ul>
</li>
<li>点击 <strong>Save</strong>。</li>
</ol>
<h2 id="4-推送代码并查看结果"><a href="#4-推送代码并查看结果" class="headerlink" title="4.推送代码并查看结果"></a>4.推送代码并查看结果</h2><ol>
<li><code>git add .</code></li>
<li><code>git commit -m &quot;Setup GitHub Actions CI/CD&quot;</code></li>
<li><code>git push origin main</code></li>
</ol>
<p><strong>查看效果：</strong></p>
<ol>
<li>进入 GitHub 仓库的 <strong>Actions</strong> 标签页。</li>
<li>你会看到一个叫 <code>API Automated Testing</code> 的任务正在转圈圈。</li>
<li>点进去看详情，如果全部绿色（Success）。</li>
<li>等待几分钟后，去 <strong>Settings -&gt; Pages</strong> 页面，它会给你一个网址（例如 <code>https://yourname.github.io/repo-name/</code>）。</li>
<li><strong>点开那个网址，就是你的 Allure 在线测试报告！</strong></li>
</ol>
<hr>
<h1 id="MCP工具开发"><a href="#MCP工具开发" class="headerlink" title="MCP工具开发"></a>MCP工具开发</h1><h2 id="Chrome-DevTools"><a href="#Chrome-DevTools" class="headerlink" title="Chrome DevTools"></a>Chrome DevTools</h2><p><strong>Chrome DevTools</strong>（Chrome 开发者工具）是内置在 Google Chrome 浏览器中的一套强大的 <strong>Web 开发和调试工具</strong>。</p>
<p>可以把它想象成一个“网页手术台”，它允许开发者直接深入到任何网页的内部，查看其源代码、修改样式、监控数据传输并诊断性能问题。</p>
<hr>
<h3 id="1-核心面板及其作用"><a href="#1-核心面板及其作用" class="headerlink" title="1. 核心面板及其作用"></a>1. 核心面板及其作用</h3><p>Chrome DevTools 由多个“面板”组成，每个面板针对不同的任务：</p>
<table>
<thead>
<tr>
<th><strong>面板名称</strong></th>
<th><strong>主要用途</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>Elements (元素)</strong></td>
<td><strong>查看和修改 DOM&#x2F;CSS</strong>。可以实时编辑 HTML 文本或修改 CSS 样式，查看页面如何立即发生变化，非常适合调试布局。</td>
</tr>
<tr>
<td><strong>Console (控制台)</strong></td>
<td><strong>运行 JS 代码和查看日志</strong>。开发者通过 <code>console.log()</code> 打印的消息会出现在这里。也可以在这里直接输入指令与网页交互。</td>
</tr>
<tr>
<td><strong>Sources (源代码)</strong></td>
<td><strong>断点调试 JavaScript</strong>。可以在代码执行的某一行暂停，查看当时的变量状态，找出逻辑错误。</td>
</tr>
<tr>
<td><strong>Network (网络)</strong></td>
<td><strong>监控资源请求</strong>。查看网页加载了哪些图片、脚本和 API 请求，分析请求耗时，诊断加载慢的原因。</td>
</tr>
<tr>
<td><strong>Performance (性能)</strong></td>
<td><strong>分析运行效率</strong>。记录网页加载和运行时的 CPU&#x2F;内存占用，找出导致页面卡顿的“元凶”。</td>
</tr>
<tr>
<td><strong>Application (应用)</strong></td>
<td><strong>管理存储数据</strong>。查看和修改 Cookie、Local Storage、Session Storage 以及缓存文件。</td>
</tr>
<tr>
<td><strong>Lighthouse</strong></td>
<td><strong>自动化质量检测</strong>。一键生成报告，针对性能、辅助功能、SEO 等给出优化建议。</td>
</tr>
</tbody></table>
<hr>
<h3 id="2-谁会用到它？"><a href="#2-谁会用到它？" class="headerlink" title="2. 谁会用到它？"></a>2. 谁会用到它？</h3><ul>
<li><strong>前端工程师：</strong> 最主要的用户，用于编写代码、调试样式、修复 JS 漏洞。</li>
<li><strong>测试人员：</strong> 用来模拟弱网环境（Throttling）、查看 API 报错或检查移动端适配。</li>
<li><strong>UI&#x2F;UX 设计师：</strong> 在浏览器里直接微调颜色、字体和间距，确认视觉效果。</li>
<li><strong>后端开发者：</strong> 检查前端发送的请求参数和接收到的后端响应数据。</li>
</ul>
<hr>
<h3 id="3-如何开启？"><a href="#3-如何开启？" class="headerlink" title="3. 如何开启？"></a>3. 如何开启？</h3><p>在 Chrome 浏览器中，有几种方式打开它：</p>
<ol>
<li><strong>右键点击：</strong> 在页面任何地方点击右键，选择“<strong>检查</strong>”（Inspect）。</li>
<li><strong>快捷键：</strong> * Windows&#x2F;Linux: <code>F12</code> 或 <code>Ctrl + Shift + I</code><ul>
<li>macOS: <code>Cmd + Option + I</code></li>
</ul>
</li>
<li><strong>菜单栏：</strong> 点击浏览器右上角的三个点 -&gt; <strong>更多工具</strong> -&gt; <strong>开发者工具</strong>。</li>
</ol>
<hr>
<h3 id="4-为什么它这么重要？"><a href="#4-为什么它这么重要？" class="headerlink" title="4. 为什么它这么重要？"></a>4. 为什么它这么重要？</h3><ul>
<li><strong>无需修改源码：</strong> 你可以在 DevTools 里尝试任何修改，刷新页面后一切都会恢复原样。这让它成为了一个完美的“实验沙盒”。</li>
<li><strong>模拟移动设备：</strong> 它内置了设备模式，可以让你在电脑上完美模拟 iPhone、安卓手机或平板的屏幕尺寸和触摸操作。</li>
<li><strong>完全免费：</strong> 作为浏览器的内置功能，它无需安装，随点随用。</li>
</ul>
<hr>
<h2 id="Chrome-DevTools-MCP"><a href="#Chrome-DevTools-MCP" class="headerlink" title="Chrome DevTools MCP"></a>Chrome DevTools MCP</h2><p>Chrome DevTools MCP 是一个基于 Model Context Protocol (MCP) 的服务器，它允许 AI 助手通过 Chrome DevTools Protocol 与浏览器交互。</p>
<h3 id="核心功能"><a href="#核心功能" class="headerlink" title="核心功能"></a>核心功能</h3><ul>
<li>🌐 浏览器自动化（导航、点击、输入等）</li>
<li>📸 页面截图和快照</li>
<li>🔍 网络请求监控和导出</li>
<li>🎯 性能追踪</li>
<li>🐛 控制台日志收集</li>
</ul>
<p>简单来说，<strong>Chrome DevTools MCP</strong>（Model Context Protocol）是 Google 为 AI 时代打造的一座“桥梁”。</p>
<p>如果说传统的 DevTools 是给<strong>人类开发者</strong>用的工具，那么 Chrome DevTools MCP 就是给 <strong>AI 助手</strong>（如 Claude、Cursor、Gemini）用的“眼睛”和“手”。</p>
<hr>
<h3 id="1-为什么需要它？"><a href="#1-为什么需要它？" class="headerlink" title="1. 为什么需要它？"></a>1. 为什么需要它？</h3><p>在过去，让 AI 写一段网页代码，它只能“盲写”。它不知道代码运行起来后样式是否错位，也不知道浏览器控制台是否在报错。</p>
<p>有了 MCP 协议，AI 助手可以直接连接并操作一个真实的 Chrome 浏览器实例。</p>
<h3 id="2-它能让-AI-做什么？"><a href="#2-它能让-AI-做什么？" class="headerlink" title="2. 它能让 AI 做什么？"></a>2. 它能让 AI 做什么？</h3><p>通过 MCP 服务器，AI 助手获得了以下“超能力”：</p>
<ul>
<li><strong>实时观察：</strong> AI 可以截取网页快照、获取 DOM 树结构，看到网页长什么样。</li>
<li><strong>模拟操作：</strong> AI 可以自动点击按钮、填写表单、滚动页面，就像真实用户一样操作。</li>
<li><strong>诊断错误：</strong> AI 能读取浏览器控制台（Console）的报错日志，或者分析网络请求（Network）里的数据。</li>
<li><strong>性能分析：</strong> AI 可以运行 Lighthouse 审计或录制性能轨迹（Performance Trace），然后直接告诉你哪里拖慢了速度。</li>
</ul>
<h3 id="3-核心组件"><a href="#3-核心组件" class="headerlink" title="3. 核心组件"></a>3. 核心组件</h3><ul>
<li><strong>MCP Server (服务器端)：</strong> 由 Google 提供的官方工具，它通过 Puppeteer 等技术控制 Chrome 浏览器。</li>
<li><strong>MCP Client (客户端)：</strong> 你使用的 AI 助手（如 VS Code 里的 Cursor、Claude Desktop 等）。</li>
</ul>
<hr>
<h3 id="4-典型使用场景"><a href="#4-典型使用场景" class="headerlink" title="4. 典型使用场景"></a>4. 典型使用场景</h3><table>
<thead>
<tr>
<th><strong>场景</strong></th>
<th><strong>AI 如何利用 MCP</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>UI 修复</strong></td>
<td>你说“侧边栏在手机上显示不全”，AI 会自动调整浏览器尺寸，检查 CSS 布局，直接修改代码并验证是否修好。</td>
</tr>
<tr>
<td><strong>自动化测试</strong></td>
<td>你说“帮我测试登录流程”，AI 会自动打开页面，输入测试账号，观察点击登录后是否有跳转或报错。</td>
</tr>
<tr>
<td><strong>性能优化</strong></td>
<td>你说“网站加载太慢了”，AI 会运行性能分析工具，查看耗时最长的资源，并给出具体的代码改进建议。</td>
</tr>
</tbody></table>
<hr>
<h2 id="二次开发MCP"><a href="#二次开发MCP" class="headerlink" title="二次开发MCP"></a>二次开发MCP</h2><p>在 MCP 中，每个功能被称为一个 <strong>Tool</strong>。二次开发的核心就是注册一个tool。</p>
<h3 id="1-理解项目架构"><a href="#1-理解项目架构" class="headerlink" title="1. 理解项目架构"></a>1. 理解项目架构</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs nix">src<span class="hljs-symbol">/</span><br>├── tools<span class="hljs-symbol">/</span>              <span class="hljs-comment"># 工具定义目录</span><br>│   ├── curl.ts        <span class="hljs-comment"># 你的新工具</span><br>│   ├── network.ts     <span class="hljs-comment"># 网络相关工具</span><br>│   ├── pages.ts       <span class="hljs-comment"># 页面操作工具</span><br>│   ├── ToolDefinition.ts  <span class="hljs-comment"># 工具类型定义</span><br>│   └── tools.ts       <span class="hljs-comment"># 工具注册中心</span><br>├── McpContext.ts      <span class="hljs-comment"># 上下文管理（浏览器状态）</span><br>├── McpResponse.ts     <span class="hljs-comment"># 响应格式化</span><br>└── third_party<span class="hljs-symbol">/</span>       <span class="hljs-comment"># Puppeteer 等依赖</span><br></code></pre></td></tr></table></figure>

<h3 id="2-核心概念"><a href="#2-核心概念" class="headerlink" title="2. 核心概念"></a>2. 核心概念</h3><h4 id="ToolDefinition"><a href="#ToolDefinition" class="headerlink" title="ToolDefinition"></a>ToolDefinition</h4><p>每个工具都是一个 <code>ToolDefinition</code> 对象：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> yourTool = <span class="hljs-title function_">defineTool</span>(&#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;tool_name&#x27;</span>,              <span class="hljs-comment">// 工具名称（snake_case）</span><br>  <span class="hljs-attr">description</span>: <span class="hljs-string">&#x27;工具描述&#x27;</span>,         <span class="hljs-comment">// 给 AI 看的说明</span><br>  <span class="hljs-attr">annotations</span>: &#123;<br>    <span class="hljs-attr">category</span>: <span class="hljs-title class_">ToolCategory</span>.<span class="hljs-property">XXX</span>,   <span class="hljs-comment">// 工具分类</span><br>    <span class="hljs-attr">readOnlyHint</span>: <span class="hljs-literal">true</span>/<span class="hljs-literal">false</span>,     <span class="hljs-comment">// 是否只读</span><br>  &#125;,<br>  <span class="hljs-attr">schema</span>: &#123;                        <span class="hljs-comment">// 参数定义（Zod schema）</span><br>    <span class="hljs-attr">param1</span>: zod.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">&#x27;参数说明&#x27;</span>),<br>  &#125;,<br>  <span class="hljs-attr">handler</span>: <span class="hljs-title function_">async</span> (request, response, context) =&gt; &#123;<br>    <span class="hljs-comment">// 工具逻辑</span><br>  &#125;,<br>&#125;);<br></code></pre></td></tr></table></figure>

<h4 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h4><p><code>context</code> 提供了访问浏览器状态的方法：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript">context.<span class="hljs-title function_">getSelectedPage</span>()           <span class="hljs-comment">// 获取当前页面</span><br>context.<span class="hljs-title function_">getNetworkRequests</span>()        <span class="hljs-comment">// 获取网络请求</span><br>context.<span class="hljs-title function_">getConsoleData</span>()            <span class="hljs-comment">// 获取控制台日志</span><br>context.<span class="hljs-title function_">saveFile</span>(data, filename)    <span class="hljs-comment">// 保存文件</span><br></code></pre></td></tr></table></figure>

<h4 id="Response"><a href="#Response" class="headerlink" title="Response"></a>Response</h4><p><code>response</code> 用于返回结果给 AI：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript">response.<span class="hljs-title function_">appendResponseLine</span>(<span class="hljs-string">&#x27;文本内容&#x27;</span>)<br>response.<span class="hljs-title function_">attachImage</span>(imageData)<br>response.<span class="hljs-title function_">setIncludeNetworkRequests</span>(<span class="hljs-literal">true</span>)<br></code></pre></td></tr></table></figure>

<h3 id="3-开发步骤"><a href="#3-开发步骤" class="headerlink" title="3. 开发步骤"></a>3. 开发步骤</h3><h4 id="Step-1-创建工具文件"><a href="#Step-1-创建工具文件" class="headerlink" title="Step 1: 创建工具文件"></a>Step 1: 创建工具文件</h4><p>在 <code>src/tools/</code> 下创建 <code>your_tool.ts</code>：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">import</span> &#123;zod&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../third_party/index.js&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123;<span class="hljs-title class_">ToolCategory</span>&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./categories.js&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123;defineTool&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./ToolDefinition.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> yourTool = <span class="hljs-title function_">defineTool</span>(&#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;your_tool_name&#x27;</span>,<br>  <span class="hljs-attr">description</span>: <span class="hljs-string">&#x27;What your tool does&#x27;</span>,<br>  <span class="hljs-attr">annotations</span>: &#123;<br>    <span class="hljs-attr">category</span>: <span class="hljs-title class_">ToolCategory</span>.<span class="hljs-property">NETWORK</span>, <span class="hljs-comment">// 或其他分类</span><br>    <span class="hljs-attr">readOnlyHint</span>: <span class="hljs-literal">true</span>,<br>  &#125;,<br>  <span class="hljs-attr">schema</span>: &#123;<br>    <span class="hljs-comment">// 定义参数</span><br>    <span class="hljs-attr">param1</span>: zod.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">&#x27;Parameter description&#x27;</span>),<br>  &#125;,<br>  <span class="hljs-attr">handler</span>: <span class="hljs-title function_">async</span> (request, response, context) =&gt; &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// 1. 获取参数</span><br>      <span class="hljs-keyword">const</span> param1 = request.<span class="hljs-property">params</span>.<span class="hljs-property">param1</span>;<br>      <br>      <span class="hljs-comment">// 2. 执行逻辑</span><br>      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">doSomething</span>(param1);<br>      <br>      <span class="hljs-comment">// 3. 返回结果</span><br>      response.<span class="hljs-title function_">appendResponseLine</span>(<span class="hljs-string">`Result: <span class="hljs-subst">$&#123;result&#125;</span>`</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>      <span class="hljs-keyword">const</span> message = error <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span> ? error.<span class="hljs-property">message</span> : <span class="hljs-title class_">String</span>(error);<br>      response.<span class="hljs-title function_">appendResponseLine</span>(<span class="hljs-string">`Error: <span class="hljs-subst">$&#123;message&#125;</span>`</span>);<br>    &#125;<br>  &#125;,<br>&#125;);<br></code></pre></td></tr></table></figure>

<h4 id="Step-2-注册工具"><a href="#Step-2-注册工具" class="headerlink" title="Step 2: 注册工具"></a>Step 2: 注册工具</h4><p>在 <code>src/tools/tools.ts</code> 中导入并注册：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> yourTools <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./your_tool.js&#x27;</span>;<br><br><span class="hljs-keyword">const</span> tools = [<br>  ...<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">values</span>(yourTools),  <span class="hljs-comment">// 添加这行</span><br>  <span class="hljs-comment">// ... 其他工具</span><br>] <span class="hljs-keyword">as</span> <span class="hljs-title class_">ToolDefinition</span>[];<br></code></pre></td></tr></table></figure>

<h4 id="Step-3-扩展-Context-类型（如需要）"><a href="#Step-3-扩展-Context-类型（如需要）" class="headerlink" title="Step 3: 扩展 Context 类型（如需要）"></a>Step 3: 扩展 Context 类型（如需要）</h4><p>如果需要访问 <code>McpContext</code> 中未暴露的方法，在 <code>src/tools/ToolDefinition.ts</code> 中扩展 <code>Context</code> 类型：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Context</span> = <span class="hljs-title class_">Readonly</span>&lt;&#123;<br>  <span class="hljs-comment">// ... 现有方法</span><br>  <span class="hljs-title function_">yourNewMethod</span>(): <span class="hljs-title class_">SomeType</span>;  <span class="hljs-comment">// 添加新方法签名</span><br>&#125;&gt;;<br></code></pre></td></tr></table></figure>

<h4 id="Step-4-构建和测试"><a href="#Step-4-构建和测试" class="headerlink" title="Step 4: 构建和测试"></a>Step 4: 构建和测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm run build<br></code></pre></td></tr></table></figure>

<p>构建产物在 <code>build/src/index.js</code>。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%B5%8B%E5%BC%80%E9%A1%B9%E7%9B%AE/" class="category-chain-item">测开项目</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95/" class="print-no-link">#接口测试</a>
      
        <a href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/" class="print-no-link">#自动化测试</a>
      
        <a href="/tags/UI%E6%B5%8B%E8%AF%95/" class="print-no-link">#UI测试</a>
      
        <a href="/tags/MCP-Server/" class="print-no-link">#MCP Server</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>自动化测试框架开发</div>
      <div>https://lilpear2002.github.io/2026/01/14/自动化测试框架开发/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>测开求职者</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2026年1月14日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2026/01/02/rag-app%E5%BC%80%E5%8F%91/" title="rag-app开发">
                        <span class="hidden-mobile">rag-app开发</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
